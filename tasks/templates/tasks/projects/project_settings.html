{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.name }} - –ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block header_title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî {{ project.name }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="flex items-center gap-2 text-sm min-w-0">
    <ol class="flex items-center gap-2 list-none">
        <li><a href="{% url 'index' %}" class="text-gray-500 hover:text-white transition-colors">Home</a><span class="text-gray-600 mx-1">/</span></li>
        <li><a href="{% url 'settings' %}" class="text-gray-500 hover:text-white transition-colors">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a><span class="text-gray-600 mx-1">/</span></li>
        <li><a href="{% url 'settings' %}#settings-projects" class="text-gray-500 hover:text-white transition-colors">–ü—Ä–æ–µ–∫—Ç—ã</a><span class="text-gray-600 mx-1">/</span></li>
        <li class="font-medium text-white truncate">{{ project.key }} ‚Äî {{ project.name }}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<div class="settings-page ps-workspace">
    <!-- Header -->
    <div class="project-header-bar ps-header-bar">
        <div class="breadcrumb">
            <a href="{% url 'settings' %}">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            <span>/</span>
            <a href="{% url 'settings' %}#settings-projects">–ü—Ä–æ–µ–∫—Ç—ã</a>
            <span>/</span>
            <span class="project-key-badge" style="background: {{ project.color }}20; color: {{ project.color }};">{{ project.key }}</span>
            <span>{{ project.name }}</span>
        </div>
    </div>

    <div class="settings-container">
        <div class="settings-nav">
            <a href="#general" class="nav-item active" data-tab="general">–û—Å–Ω–æ–≤–Ω—ã–µ</a>
            <a href="#members" class="nav-item" data-tab="members">–£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
            <a href="#integrations" class="nav-item" data-tab="integrations">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</a>
            {% if can_delete %}
            <a href="#danger" class="nav-item danger" data-tab="danger">Danger Zone</a>
            {% endif %}
        </div>

        <div class="settings-content">
            <!-- General Settings -->
            <div class="tab-content active" id="tab-general">
                <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <form id="generalSettingsForm" onsubmit="saveGeneralSettings(event)">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" name="name" value="{{ project.name }}" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>–ö–ª—é—á –ø—Ä–æ–µ–∫—Ç–∞</label>
                            <input type="text" value="{{ project.key }}" disabled>
                            <small>–ö–ª—é—á –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è</small>
                        </div>
                        <div class="form-group">
                            <label>–¶–≤–µ—Ç</label>
                            <input type="color" name="color" value="{{ project.color }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" rows="4">{{ project.description }}</textarea>
                    </div>

                    <div class="form-group">
                        <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <select name="default_assignee_id">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                            {% for member in members %}
                            <option value="{{ member.user.id }}"
                                {% if project.default_assignee_id == member.user.id %}selected{% endif %}>
                                {{ member.user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="is_public" {% if project.is_public %}checked{% endif %}>
                            –ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç (–≤–∏–¥–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>

            <!-- Members -->
            <div class="tab-content" id="tab-members">
                <div class="members-header">
                    <h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openInviteModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <path d="M20 8v6m3-3h-6"></path>
                            </svg>
                            –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
                        </button>
                        {% if user_teams %}
                        <span class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 8px;">
                            <select id="addTeamSelect" style="background: var(--ps-deep); border: 1px solid var(--ps-border); border-radius: 8px; padding: 8px 12px; color: var(--ps-text); font-size: 0.875rem;">
                                <option value="">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É...</option>
                                {% for t in user_teams %}
                                <option value="{{ t.id }}">{{ t.name }}</option>
                                {% endfor %}
                            </select>
                            <select id="addTeamRole" style="background: var(--ps-deep); border: 1px solid var(--ps-border); border-radius: 8px; padding: 8px 12px; color: var(--ps-text); font-size: 0.875rem;">
                                <option value="member">–£—á–∞—Å—Ç–Ω–∏–∫</option>
                                <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                                <option value="viewer">–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                            </select>
                            <button type="button" class="btn btn-primary" style="padding: 8px 14px;" onclick="addTeamToProject()">–í –ø—Ä–æ–µ–∫—Ç</button>
                        </span>
                        <span id="addTeamMessage" style="font-size: 0.8125rem; color: var(--ps-muted); align-self: center;"></span>
                        {% endif %}
                    </div>
                </div>

                <div class="members-list">
                    {% for member in members %}
                    <div class="member-card">
                        <div class="member-avatar" style="background: hsl({{ member.user.id|add:180 }}, 70%, 60%);">
                            {{ member.user.username|slice:":1"|upper }}
                        </div>
                        <div class="member-info">
                            <div class="member-name">{{ member.user.username }}</div>
                            <div class="member-email">{{ member.user.email }}</div>
                        </div>
                        <div class="member-role">
                            {% if member.role == 'owner' %}
                            <span class="role-badge owner">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                            {% else %}
                            <select class="role-select" onchange="changeRole({{ member.user.id }}, this.value)"
                                    {% if member.role == 'owner' %}disabled{% endif %}>
                                <option value="admin" {% if member.role == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                                <option value="member" {% if member.role == 'member' %}selected{% endif %}>–£—á–∞—Å—Ç–Ω–∏–∫</option>
                                <option value="viewer" {% if member.role == 'viewer' %}selected{% endif %}>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                            </select>
                            {% endif %}
                        </div>
                        {% if member.role != 'owner' %}
                        <button class="remove-btn" onclick="removeMember({{ member.user.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"></path>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Pending Invitations -->
                <div id="pendingInvitations" class="pending-section" style="display: none;">
                    <h3>–û–∂–∏–¥–∞—é—â–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h3>
                    <div id="invitationsList"></div>
                </div>
            </div>

            <!-- Integrations -->
            <div class="tab-content" id="tab-integrations">
                <h2>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h2>
                <p class="text-secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏</p>

                <div class="integration-card">
                    <div class="integration-icon">üìã</div>
                    <div class="integration-info">
                        <h4>Jira</h4>
                        <p>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á —Å Jira</p>
                    </div>
                    <span class="integration-status">–°–∫–æ—Ä–æ</span>
                </div>

                <div class="integration-card">
                    <div class="integration-icon">üêô</div>
                    <div class="integration-info">
                        <h4>GitHub Issues</h4>
                        <p>–ò–º–ø–æ—Ä—Ç issues –∏–∑ GitHub</p>
                    </div>
                    <span class="integration-status">–°–∫–æ—Ä–æ</span>
                </div>
            </div>

            <!-- Danger Zone -->
            {% if can_delete %}
            <div class="tab-content" id="tab-danger">
                <h2 class="text-danger">Danger Zone</h2>
                <p class="text-secondary">–ù–µ–æ–±—Ä–∞—Ç–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–æ–µ–∫—Ç–æ–º</p>

                <div class="danger-actions">
                    <div class="danger-card">
                        <div class="danger-info">
                            <h4>–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h4>
                            <p>–ü—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –∏–∑ —Å–ø–∏—Å–∫–∞, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è</p>
                        </div>
                        <button class="btn btn-warning" onclick="archiveProject()">
                            {% if project.archived_at %}–†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% else %}–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% endif %}
                        </button>
                    </div>

                    <div class="danger-card">
                        <div class="danger-info">
                            <h4>–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</h4>
                            <p>–í—Å–µ –∑–∞–¥–∞—á–∏, —Å–ø—Ä–∏–Ω—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞</p>
                        </div>
                        <button class="btn btn-danger" onclick="deleteProject()">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Invite Modal (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ: –≥–ª–æ–±–∞–ª—å–Ω—ã–π .modal –¥–∞—ë—Ç display:flex, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º) -->
<div id="inviteModal" class="modal ps-modal-invite ps-modal-hidden" role="dialog" aria-modal="true" aria-labelledby="inviteModalTitle" aria-hidden="true">
    <div class="modal-backdrop" id="inviteModalBackdrop" title="–ó–∞–∫—Ä—ã—Ç—å (–∫–ª–∏–∫ –≤–Ω–µ –æ–∫–Ω–∞)"></div>
    <div class="modal-content" role="document">
        <div class="modal-header">
            <h2 id="inviteModalTitle">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
            <button type="button" class="close-btn" onclick="closeInviteModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
        </div>
        <form id="inviteForm" onsubmit="sendInvite(event)" class="modal-form">
            <div class="form-group">
                <label for="inviteEmail">Email <span class="required">*</span></label>
                <input type="email" name="email" id="inviteEmail" required placeholder="user@example.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label for="inviteRole">–†–æ–ª—å</label>
                <select name="role" id="inviteRole">
                    <option value="member">–£—á–∞—Å—Ç–Ω–∏–∫</option>
                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    <option value="viewer">–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                </select>
            </div>
            <div class="form-group">
                <label for="inviteMessage">–°–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea name="message" id="inviteMessage" rows="3" placeholder="–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeInviteModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Workspace-aligned dark theme (Outfit + tokens) */
.ps-workspace {
    --ps-void: #08080b;
    --ps-deep: #0c0c10;
    --ps-surface: #111116;
    --ps-raised: #18181f;
    --ps-hover: #1f1f28;
    --ps-border: rgba(255,255,255,0.08);
    --ps-border-hover: rgba(255,255,255,0.12);
    --ps-text: #f8fafc;
    --ps-muted: #94a3b8;
    --ps-tertiary: #64748b;
    --ps-accent: #6366f1;
    --ps-accent-soft: rgba(99,102,241,0.15);
    --ps-danger: #ef4444;
    --ps-danger-soft: rgba(239,68,68,0.12);
    --ps-warning: #f59e0b;
    font-family: 'Outfit', system-ui, sans-serif;
    min-height: 100vh;
    background: var(--ps-void);
}

.ps-workspace .ps-header-bar {
    padding: 16px 24px;
    background: var(--ps-deep);
    border-bottom: 1px solid var(--ps-border);
}

.ps-workspace .ps-header-bar .breadcrumb a,
.ps-workspace .ps-header-bar .breadcrumb span { color: var(--ps-muted); }
.ps-workspace .ps-header-bar .breadcrumb a:hover { color: var(--ps-accent); }
.ps-workspace .ps-header-bar .breadcrumb span:not([class]) { color: var(--ps-text); }

.ps-workspace .settings-container {
    display: flex;
    max-width: 1200px;
    margin: 0 auto;
    padding: 28px 24px;
    gap: 28px;
}

.ps-workspace .settings-nav {
    width: 200px;
    flex-shrink: 0;
}

.ps-workspace .settings-nav .nav-item {
    display: block;
    padding: 10px 14px;
    color: var(--ps-muted);
    text-decoration: none;
    border-radius: 10px;
    margin-bottom: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: background 0.15s, color 0.15s;
}

.ps-workspace .settings-nav .nav-item:hover {
    background: var(--ps-hover);
    color: var(--ps-text);
}

.ps-workspace .settings-nav .nav-item.active {
    background: var(--ps-accent-soft);
    color: var(--ps-accent);
}

.ps-workspace .settings-nav .nav-item.danger {
    color: var(--ps-danger);
}
.ps-workspace .settings-nav .nav-item.danger:hover { background: var(--ps-danger-soft); }

.ps-workspace .settings-content {
    flex: 1;
    background: var(--ps-surface);
    border-radius: 14px;
    padding: 28px 32px;
    border: 1px solid var(--ps-border);
}

.ps-workspace .tab-content { display: none; }
.ps-workspace .tab-content.active { display: block; }

.ps-workspace .tab-content h2 {
    margin: 0 0 20px;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--ps-text);
    letter-spacing: -0.02em;
}

.ps-workspace .tab-content .text-secondary { color: var(--ps-muted); font-size: 0.875rem; }

.ps-workspace .form-group { margin-bottom: 20px; }
.ps-workspace .form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 0.8125rem;
    color: var(--ps-muted);
}
.ps-workspace .form-group input:not([type="checkbox"]):not([type="color"]),
.ps-workspace .form-group select,
.ps-workspace .form-group textarea {
    width: 100%;
    padding: 10px 14px;
    background: var(--ps-deep);
    border: 1px solid var(--ps-border);
    border-radius: 10px;
    font-size: 0.875rem;
    color: var(--ps-text);
    font-family: inherit;
    transition: border-color 0.15s, box-shadow 0.15s;
}
.ps-workspace .form-group input:focus,
.ps-workspace .form-group select:focus,
.ps-workspace .form-group textarea:focus {
    outline: none;
    border-color: var(--ps-accent);
    box-shadow: 0 0 0 3px var(--ps-accent-soft);
}
.ps-workspace .form-group input:disabled { opacity: 0.7; cursor: not-allowed; }
.ps-workspace .form-group input[type="color"] {
    width: 48px;
    height: 40px;
    padding: 4px;
    border-radius: 8px;
    border: 1px solid var(--ps-border);
    cursor: pointer;
}
.ps-workspace .form-group small {
    display: block;
    margin-top: 6px;
    color: var(--ps-tertiary);
    font-size: 0.75rem;
}
.ps-workspace .form-row { display: flex; gap: 20px; }
.ps-workspace .form-row .form-group { flex: 1; }
.ps-workspace .checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    color: var(--ps-muted);
    font-size: 0.875rem;
}
.ps-workspace .checkbox-label input { accent-color: var(--ps-accent); }

/* Members */
.ps-workspace .members-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.ps-workspace .members-list { display: flex; flex-direction: column; gap: 12px; }
.ps-workspace .member-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 18px;
    background: var(--ps-raised);
    border: 1px solid var(--ps-border);
    border-radius: 12px;
    transition: border-color 0.15s;
}
.ps-workspace .member-card:hover { border-color: var(--ps-border-hover); }
.ps-workspace .member-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 600;
    font-size: 0.9375rem;
}
.ps-workspace .member-name { font-weight: 500; color: var(--ps-text); }
.ps-workspace .member-email { font-size: 0.8125rem; color: var(--ps-tertiary); }
.ps-workspace .role-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}
.ps-workspace .role-badge.owner {
    background: rgba(139,92,246,0.2);
    color: #a78bfa;
}
.ps-workspace .role-select {
    padding: 8px 12px;
    background: var(--ps-deep);
    border: 1px solid var(--ps-border);
    border-radius: 8px;
    font-size: 0.8125rem;
    color: var(--ps-text);
}
.ps-workspace .remove-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--ps-tertiary);
    padding: 8px;
    border-radius: 8px;
    transition: background 0.15s, color 0.15s;
}
.ps-workspace .remove-btn:hover {
    background: var(--ps-danger-soft);
    color: var(--ps-danger);
}

/* Integrations */
.ps-workspace .integration-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 18px 20px;
    background: var(--ps-raised);
    border: 1px solid var(--ps-border);
    border-radius: 12px;
    margin-bottom: 12px;
}
.ps-workspace .integration-icon { font-size: 1.75rem; }
.ps-workspace .integration-info h4 { margin: 0 0 4px; color: var(--ps-text); font-size: 0.9375rem; }
.ps-workspace .integration-info p { margin: 0; font-size: 0.8125rem; color: var(--ps-tertiary); }
.ps-workspace .integration-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--ps-tertiary);
    background: var(--ps-deep);
}

/* Danger Zone */
.ps-workspace .text-danger { color: var(--ps-danger); }
.ps-workspace .danger-actions { margin-top: 20px; }
.ps-workspace .danger-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 22px;
    border: 1px solid rgba(239,68,68,0.25);
    border-radius: 12px;
    margin-bottom: 12px;
    background: var(--ps-danger-soft);
}
.ps-workspace .danger-info h4 { margin: 0 0 4px; color: var(--ps-text); font-size: 0.9375rem; }
.ps-workspace .danger-info p { margin: 0; font-size: 0.8125rem; color: var(--ps-muted); }
.ps-workspace .btn-warning {
    background: var(--ps-warning);
    color: #000;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-weight: 500;
    cursor: pointer;
    font-size: 0.875rem;
}
.ps-workspace .btn-danger {
    background: var(--ps-danger);
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-weight: 500;
    cursor: pointer;
    font-size: 0.875rem;
}

/* Modal ‚Äî –º–æ–¥–∞–ª–∫–∞ –≤–Ω–µ .ps-workspace, –ø–æ—ç—Ç–æ–º—É –∑–∞–¥–∞—ë–º –ø–æ id (–≥–ª–æ–±–∞–ª—å–Ω—ã–π .modal –¥–∞—ë—Ç display:flex) */
#inviteModal {
    --ps-surface: #111116;
    --ps-border: rgba(255,255,255,0.08);
    --ps-text: #f8fafc;
    --ps-hover: #1f1f28;
    --ps-tertiary: #64748b;
}
#inviteModal.ps-modal-hidden,
#inviteModal:not(.ps-modal-show) {
    display: none !important;
}
#inviteModal.ps-modal-show {
    display: flex !important;
    position: fixed;
    inset: 0;
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 24px;
    box-sizing: border-box;
}
#inviteModal .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.65);
    cursor: pointer;
}
#inviteModal.ps-modal-show .modal-content {
    position: relative;
    z-index: 10000;
    cursor: default;
    background: var(--ps-surface);
    border: 1px solid var(--ps-border);
    border-radius: 16px;
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 24px 48px rgba(0,0,0,0.4);
}
#inviteModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 20px;
    border-bottom: 1px solid var(--ps-border);
    flex-shrink: 0;
}
#inviteModal .modal-header h2 { margin: 0; font-size: 1.0625rem; font-weight: 600; color: var(--ps-text); }
#inviteModal .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    color: var(--ps-tertiary);
    padding: 6px;
    margin: -6px -6px -6px 0;
    border-radius: 8px;
    transition: color 0.15s, background 0.15s;
}
#inviteModal .close-btn:hover,
#inviteModal .close-btn:focus {
    color: var(--ps-text);
    background: var(--ps-hover);
    outline: none;
}
#inviteModal .modal-form { padding: 20px; }
#inviteModal .modal-form .form-group { margin-bottom: 16px; }
#inviteModal .modal-form .form-actions { margin-top: 20px; padding-top: 16px; }
.ps-workspace .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--ps-border);
}
.ps-workspace .btn {
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    font-family: inherit;
    transition: background 0.15s, transform 0.05s;
}
.ps-workspace .btn-primary {
    background: var(--ps-accent);
    color: #fff;
}
.ps-workspace .btn-primary:hover { background: #4f46e5; }
.ps-workspace .btn-secondary {
    background: var(--ps-raised);
    color: var(--ps-text);
    border: 1px solid var(--ps-border);
}
.ps-workspace .btn-secondary:hover { background: var(--ps-hover); }
.ps-workspace .required { color: var(--ps-danger); }
</style>

<script>
// Tab navigation
document.querySelectorAll('.settings-nav .nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const tab = this.dataset.tab;

        document.querySelectorAll('.settings-nav .nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        this.classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
    });
});

// Save general settings
async function saveGeneralSettings(e) {
    e.preventDefault();
    const form = e.target;

    const data = {
        name: form.name.value,
        color: form.color.value,
        description: form.description.value,
        default_assignee_id: form.default_assignee_id.value || null,
        is_public: form.is_public.checked,
    };

    try {
        const response = await fetch('{% url "settings_project" project.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(data),
        });

        const result = await response.json();
        if (result.success) {
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        } else {
            alert(result.error);
        }
    } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
}

// Invite modal (–∏—Å–ø–æ–ª—å–∑—É–µ–º ps-modal-show / ps-modal-hidden –∏–∑-–∑–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ .modal { display: flex })
function openInviteModal() {
    var modal = document.getElementById('inviteModal');
    if (!modal) return;
    modal.classList.remove('ps-modal-hidden');
    modal.classList.add('ps-modal-show');
    modal.setAttribute('aria-hidden', 'false');
    var firstInput = document.getElementById('inviteEmail');
    if (firstInput) setTimeout(function() { firstInput.focus(); }, 100);
    document.addEventListener('keydown', inviteModalEscape);
}

function closeInviteModal() {
    var modal = document.getElementById('inviteModal');
    if (!modal) return;
    modal.classList.remove('ps-modal-show');
    modal.classList.add('ps-modal-hidden');
    modal.setAttribute('aria-hidden', 'true');
    var form = document.getElementById('inviteForm');
    if (form) form.reset();
    document.removeEventListener('keydown', inviteModalEscape);
}

function inviteModalEscape(e) {
    if (e.key === 'Escape') closeInviteModal();
}

(function() {
    var backdrop = document.getElementById('inviteModalBackdrop');
    if (backdrop) backdrop.addEventListener('click', closeInviteModal);
})();

async function sendInvite(e) {
    e.preventDefault();
    const form = e.target;

    const data = {
        email: form.email.value,
        role: form.role.value,
        message: form.message.value,
    };

    try {
        const response = await fetch('{% url "tasks:project_invite" project.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(data),
        });

        const result = await response.json();
        if (result.success) {
            alert('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            closeInviteModal();
        } else {
            alert(result.error);
        }
    } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
}

// Change member role
async function changeRole(userId, newRole) {
    try {
        const response = await fetch(`{% url "tasks:project_member_role" project.id 0 %}`.replace('/0/', `/${userId}/`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ role: newRole }),
        });

        const result = await response.json();
        if (!result.success) {
            alert(result.error);
            window.location.reload();
        }
    } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
}

// Remove member
async function removeMember(userId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞?')) return;

    try {
        const response = await fetch(`{% url "tasks:project_member_remove" project.id 0 %}`.replace('/0/', `/${userId}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        });

        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert(result.error);
        }
    } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
}

// Add team to project
async function addTeamToProject() {
    var teamId = document.getElementById('addTeamSelect').value;
    var msgEl = document.getElementById('addTeamMessage');
    if (!teamId) { msgEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É'; return; }
    msgEl.textContent = '';
    try {
        var role = document.getElementById('addTeamRole').value;
        var response = await fetch('{% url "tasks:add_team_to_project" project.id 0 %}'.replace('/0/', '/' + teamId + '/'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ role: role })
        });
        var result = await response.json();
        if (result.success) {
            msgEl.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ' + (result.added || 0);
            document.getElementById('addTeamSelect').value = '';
            setTimeout(function() { window.location.reload(); }, 800);
        } else {
            msgEl.textContent = result.error || '–û—à–∏–±–∫–∞';
        }
    } catch (err) {
        msgEl.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
    }
}

// Archive project
async function archiveProject() {
    if (!confirm('{% if project.archived_at %}–†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% else %}–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% endif %} –ø—Ä–æ–µ–∫—Ç?')) return;

    try {
        const response = await fetch('{% url "tasks:project_archive" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        });

        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert(result.error);
        }
    } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
}

// Delete project
async function deleteProject() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç? –í—Å–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) return;
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;

    try {
        const response = await fetch('{% url "tasks:project_delete" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        });

        const result = await response.json();
        if (result.success) {
            window.location.href = '{% url "settings" %}#settings-projects';
        } else {
            alert(result.error);
        }
    } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
}
</script>
{% endblock %}
