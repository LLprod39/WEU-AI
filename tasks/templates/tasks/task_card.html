<div class="task-card priority-{{ task.priority|lower }} {% if task.is_overdue %}overdue{% endif %}"
     data-task-id="{{ task.id }}"
     data-priority="{{ task.priority }}"
     data-ai-assigned="{{ task.assigned_to_ai|yesno:'true,false' }}"
     draggable="true"
     onclick="openDetailModal({{ task.id }})">

    <div class="task-header">
        <h3 class="task-title">{{ task.title }}</h3>
        <div class="task-actions" onclick="event.stopPropagation()">
            <a href="/chat/?task_id={{ task.id }}" class="task-action" title="Discuss">
                <span class="material-icons-round" style="font-size: 16px;">chat</span>
            </a>
            <a href="{% url 'tasks:task_delete' task.id %}" class="task-action delete" title="Delete"
               onclick="return confirm('Delete this task?')">
                <span class="material-icons-round" style="font-size: 16px;">delete</span>
            </a>
        </div>
    </div>

    <div class="task-meta">
        {% if task.target_server %}
        <span class="task-badge server">
            <span class="material-icons-round" style="font-size: 12px;">dns</span>
            {{ task.target_server.name }}
        </span>
        {% endif %}

        {% if task.due_date %}
        <span class="task-badge due {% if task.is_overdue %}overdue{% endif %}">
            <span class="material-icons-round" style="font-size: 12px;">schedule</span>
            {{ task.due_date|date:"d M" }}
        </span>
        {% endif %}

        {% if task.estimated_duration_hours %}
        <span class="task-badge time">
            <span class="material-icons-round" style="font-size: 12px;">timer</span>
            {{ task.estimated_duration_hours }}h
        </span>
        {% endif %}

        {% if task.assigned_to_ai %}
        <span class="task-badge ai-status {% if task.ai_execution_status == 'EXECUTING' %}executing{% endif %}">
            <span class="material-icons-round" style="font-size: 12px;">smart_toy</span>
            {% if task.ai_execution_status == 'EXECUTING' %}Running{% elif task.ai_execution_status == 'COMPLETED' %}Done{% else %}AI{% endif %}
        </span>
        {% endif %}
    </div>

    {% if task.label_relations.all %}
    <div class="task-labels">
        {% for rel in task.label_relations.all %}
        <span class="task-label" style="background: {{ rel.label.color }}22; color: {{ rel.label.color }};">
            {{ rel.label.name }}
        </span>
        {% endfor %}
    </div>
    {% endif %}

    {% with progress=task.get_progress_percentage %}
    {% if task.subtasks.exists %}
    <div class="task-progress">
        <div class="task-progress-bar" style="width: {{ progress }}%"></div>
    </div>
    <div class="task-progress-text">
        {{ task.subtasks.filter.is_completed|length|default:0 }}/{{ task.subtasks.count }} subtasks
    </div>
    {% endif %}
    {% endwith %}
</div>
