# План развития проекта WEU AI Agent

## Обзор и навигация по документу

План состоит из четырёх взаимосвязанных разделов. Используйте этот обзор, чтобы быстро находить нужное.

| Раздел | Назначение | Когда смотреть |
|--------|------------|-----------------|
| **UI Improvements** | Удобство, дизайн, UX интерфейса | Планирование доработок интерфейса, онбординг, a11y, тосты, формы |
| **Feature Enhancements** | Улучшения и новые возможности продукта | Расширение чата, RAG, задач, Agent Hub, интеграции |
| **Service Improvements** | Надёжность, эффективность и эксплуатация бэкенда | Оркестратор, таймауты, Health Check, RAG/LLM, пагинация |
| **MVP for Beta Testing** | Минимальный набор для бета-тестирования | Определение scope беты, приоритеты, сроки, чек-лист |

**Связность:** Требования MVP (раздел 4) опираются на пункты из разделов 1–3; в таблицах Must Have/Should Have указаны источники (§ — номер подраздела). Работы по MVP следует вести в порядке фаз (надёжность → обратная связь → UX → по остатку времени).

---

## UI Improvements

Детальный план улучшения пользовательского интерфейса с фокусом на **удобство использования (usability)**, **визуальный дизайн** и **пользовательский опыт (UX)**. Основан на анализе текущих шаблонов (`base.html`, `chat.html`, `settings.html`, `orchestrator.html`, `knowledge_base.html`, `task_list.html`, `agents.html`), стилей (`style.css`) и гайда (`UI_GUIDE.md`).

---

### 1. Usability (Удобство использования)

#### 1.1 Навигация и ориентация
- **Хлебные крошки (breadcrumbs)**  
  В шапке сейчас только «Workspace / Dashboard». Добавить полноценные breadcrumbs на всех страницах (например: `Chat` → `Agents` → `Profile X`), чтобы пользователь всегда понимал, где находится и как вернуться.
- **Сворачиваемая боковая панель**  
  Сейчас сайдбар фиксированной ширины. Добавить режим «узкий сайдбар» (только иконки) и сохранение состояния в `localStorage`, чтобы освобождать место на маленьких экранах и по желанию пользователя.
- **Поиск по приложению (Command Palette)**  
  Глобальный поиск/действия по `Ctrl+K` (или `Cmd+K`): быстрый переход по разделам (Chat, Agents, Tasks, Settings), запуск частых операций («New task», «Clear chat»), выбор модели.
- **Явная активная страница в сайдбаре**  
  Уже есть `.active`, но на мобиле сайдбар скрыт — добавить кнопку «меню» в header для открытия навигации и индикатор текущего раздела в самом header.

#### 1.2 Доступность (a11y)
- **Фокус и клавиатура**  
  Проверить порядок табуляции, видимые `:focus-visible` состояния у всех интерактивных элементов (ссылки, кнопки, селекты, чекбоксы). Избегать `outline: none` без замены на контур/тень.
- **Контраст и шрифты**  
  Проверить сочетания `text-secondary` / `text-tertiary` на фоне `bg-surface` по WCAG 2.1 (минимум AA). Добавить опцию увеличения базового размера шрифта в «Настройки интерфейса» (уже есть «Масштаб», увязать с `font-size` контента).
- **Озвучивание**  
  Семантичная разметка: `<nav>`, `<main>`, заголовки по уровню (`h1` → `h2` → `h3`). У форм — связка `label` + `id`, у иконок — `aria-label` или `title`. Для динамического контента (чат, уведомления) — `aria-live` регионы.
- **Сокращение движения**  
  Уже учтено `prefers-reduced-motion` в CSS — сохранить и расширить: отключать aurora-анимации, уменьшать/отключать «typing» и прочие декоративные анимации.

#### 1.3 Формы и ввод
- **Валидация в реальном времени**  
  В Settings (API Keys, модели), в форме «Новая задача», в Knowledge Base (добавление документа) — показывать ошибки рядом с полями при потере фокуса или при отправке, без только alert/confirm.
- **Сохранение черновиков**  
  Для длинных форм (например, описание задачи в Agent Hub, текст в чате) — по возможности сохранять черновик в `localStorage` и восстанавливать при возврате или перезагрузке, с индикатором «есть несохранённые данные».
- **Подсказки и плейсхолдеры**  
  Там, где поле неочевидное (например, «RAG · модель эмбеддингов», «или свой model id») — добавить короткие пояснения под полем или тултипы по иконке «?».
- **Клавиатурные сокращения в чате**  
  Реализовать из UI_GUIDE: `Ctrl+P` — провайдер, `Ctrl+M` — модель, `Ctrl+R` — RAG, `Ctrl+Enter` — отправить. Показать подсказку при фокусе в поле ввода («Ctrl+Enter — отправить»).

#### 1.4 Обратная связь и состояние системы
- **Загрузки и сабмиты**  
  У всех кнопок, инициирующих запрос (Сохранить, Search, Run, Add document), — индикатор загрузки (спиннер/disabled + «Сохранение…») и блокировка повторного нажатия.
- **Глобальные тосты/уведомления**  
  Вместо или в дополнение к `alert()`/`confirm()` — единая система тостов (например, в углу экрана): успех/ошибка/инфо, авто-скрытие, очередь, возможность отключить анимации в настройках.
- **Пустые состояния**  
  Для пустых списков (задачи, документы KB, агенты, серверы) — не просто «нет данных», а короткий текст + призыв к действию («Создать задачу», «Добавить документ») и опционально иллюстрация или иконка.
- **Статус «Online» в header**  
  Сделать осмысленным: проверка доступности бэкенда (например, лёгкий `/api/health` или учёт ответов API), отображение «Offline» / «Reconnecting» при сбоях.

---

### 2. Design (Визуальный дизайн)

#### 2.1 Консистентность
- **Единый набор компонентов**  
  Вынести повторяющиеся паттерны в переиспользуемые «куски» (Django `include` или фрагменты): карточки (glass-card), кнопки (primary/ghost), поля ввода, селекты, бейджи статусов. Опираться на уже заданные переменные (`--primary`, `--radius-md`, `--spacing-*`).
- **Типографическая шкала**  
  Зафиксировать использование `--text-xs` … `--text-2xl` и весов по иерархии: заголовки страниц, заголовки секций, тело текста, подписи. Один стиль для всех «title» страниц, один для «section title».
- **Отступы и сетка**  
  На всех страницах придерживаться одной сетки (например, 8px базовый шаг) и одинаковых внутренних отступов контента (`p-6` / `max-w-*` / `space-y-6`), чтобы визуальный ритм был предсказуемым.

#### 2.2 Цвет и контраст
- **Семантика цветов**  
  Закрепить и довести до всех экранов: primary — основные действия и выделение; accent — второстепенные акценты; success/warning/error — только для статусов и сообщений об исходе. В UI_GUIDE уже заданы Gemini/Grok/RAG — использовать их последовательно в селекторах и бейджах.
- **Светлая тема**  
  Сейчас есть `[data-theme="light"]` в base и CSS. Проверить все страницы (включая Chat, Agents, Tasks, KB, Settings) на читаемость и контраст в light mode; при необходимости доработать границы, тени и фон карточек.
- **Границы и разделители**  
  Унифицировать: везде использовать `--border-subtle` / `--border-default`, без разрозненных `border-white/5`, `border-white/10`, чтобы при смене темы не было «ломающихся» мест.

#### 2.3 Компоненты и микро-интерфейс
- **Кнопки**  
  Чёткие состояния: default, hover, active, disabled, loading. Единые размеры (например, «sm / md / lg») и достаточная область нажатия (минимум ~44px по осям для основных действий).
- **Карточки и списки**  
  Единый hover-эффект (лёгкий lift + тень), скругления из `--radius-lg`. В списках — разделители или отступы между элементами, чтобы строки не сливались.
- **Иконки**  
  Один набор (уже Material Icons Round) и один условный размер по контексту (например, 18px в списках, 24px в кнопках). Там, где иконка — единственный смысл действия, добавлять `aria-label`/`title`.
- **Скроллбары**  
  Текущий кастомный скроллбар оставить, но убедиться, что он виден и на light, и на dark и не «теряется» на стеклянных панелях.

#### 2.4 Фон и атмосфера
- **Aurora и шум**  
  Сохранить как опцию; в настройках интерфейса добавить «Упрощённый фон» (без aurora, без/с меньшим шумом) для пользователей, которым нужен более спокойный экран или лучшая производительность.
- **Glass-эффекты**  
  Сейчас используются `glass-sm/md/lg`. Для мобильных устройств предусмотреть возможность снижения `backdrop-filter` (или отключения) через медиа или настройку «Упростить интерфейс».

---

### 3. User Experience (Пользовательский опыт)

#### 3.1 Первое использование и онбординг
- **Приветствие при первом входе**  
  Краткий онбординг: что умеет система (чат, агенты, база знаний, задачи), куда идти за чем. Один экран с 3–4 шагами или подсказками у ключевых элементов, возможность пропустить и «не показывать снова».
- **Подсказки на пустом состоянии чата**  
  Уже есть Quick Actions (Web Search, File Analysis, SSH, Tools) — оставить и при необходимости добавить 1–2 сценария «типовых запросов» под вашу аудиторию.
- **Быстрая проверка настроек**  
  На первой загрузке или при первом запросе к API — если ключи не заданы или модель не выбрана, показать ненавязчивое уведомление со ссылкой на Settings, без блокировки интерфейса.

#### 3.2 Повседневные сценарии
- **Чат**  
  - Сохранение и восстановление истории в рамках сессии; явная кнопка «Clear History» с подтверждением — уже есть, сохранить.  
  - При длинных ответах — «свернуть/развернуть» по клику на заголовок блока или кнопку «Show more».  
  - Копирование кода и ответов в один клик (иконка «copy» у блока).  
  - Модель и RAG в шапке чата или над полем ввода — видимы без лишних кликов; текущие селекторы оформить компактно, чтобы не съедали вертикаль.
- **Agents / Task builder**  
  - Прогресс длинных операций: не только «Выполняется…», но и пошаговый статус там, где бэкенд может его отдавать (например, «Шаг 2 из 5»).  
  - Логи в модалке — авто-скролл к последней строке, кнопка «Copy full log», по возможности подсветка ошибок.  
  - После успешного запуска — короткое сообщение «Готово» и возможность быстро перейти к результату или к списку задач.
- **Knowledge Base**  
  - После добавления документа — явное «Документ добавлен» и обновление счётчика в статус-баре без перезагрузки.  
  - В результатах поиска — выделение совпадений (snippet) и переход к нужному документу.  
  - Предупреждение при «Reset» с возможностью отмены и коротким объяснением последствий.
- **Tasks**  
  - При перетаскивании карточки — визуальная «посадочная» зона (подсветка колонки/полосы), чтобы было понятно, куда попадёт задача.  
  - Фильтры/поиск по доске (по тексту, по метке, по исполнителю — в зависимости от модели).  
  - В модалке создания/редактирования — обязательные поля помечены, ошибки показываются у полей.

#### 3.3 Производительность и отзывчивость
- **Скелетоны вместо «загрузка…»**  
  На Settings, Knowledge Base, списках задач/агентов — при загрузке показывать скелетоны карточек/строк, а не только спиннер или текст «Загрузка…».
- **Виртуализация длинных списков**  
  Для очень длинных лент (чат, документы KB, логи) рассмотреть рендер только видимой области с подгрузкой при скролле, чтобы не тормозить при сотнях элементов.
- **Оптимизация первой отрисовки**  
  Критичные стили — инлайном или в первом запросе; шрифты — `font-display: swap`; по возможности отложить тяжёлые скрипты (highlight.js и т.п.) до момента, когда они реально нужны (например, при появлении первого блока кода в чате).

#### 3.4 Язык и тон
- **Единый язык интерфейса**  
  Сейчас смешаны русский и английский (например, «Sign Out» при «Настройки интерфейса»). Определить один рабочий язык (или полноценную i18n) и привести подписи кнопок, заголовки, сообщения к одному стилю.
- **Текст ошибок и подсказок**  
  Формулировки должны быть понятными без знания кода: не «401 Unauthorized», а «Сессия истекла. Войдите снова» с кнопкой перехода на логин; не «model id», а «Идентификатор модели (если используете свою)».
- **Тональность**  
  Сохранять нейтрально-профессиональный тон в интерфейсе; в чате тон задаётся промптами и ответами модели.

---

### 4. Технические и организационные шаги

- **Документирование компонентов**  
  В `docs/UI_GUIDE.md` или в новом `docs/COMPONENTS.md` описать стандартные блоки (кнопка, карточка, поле, тост) и когда что использовать.
- **Чек-лист перед релизом**  
  В план включить проверки: контраст (a11y), фокус и табуляция, работа в одной только клавиатуре, быстрый прогон по сценариям (чат, задача, KB, настройки) в light/dark и на узком экране.
- **Сбор обратной связи**  
  По возможности добавить механизм «Сообщить о проблеме» / «Предложить улучшение» (ссылкой на GitHub/GitLab или внутренний тикет), чтобы новые идеи по UI попадали в следующий цикл улучшений.

---

Этот раздел можно использовать как дорожную карту: выбирать пункты по приоритету (например, сначала тосты и валидация, затем a11y и Command Palette, затем онбординг и скелетоны) и отмечать выполнение прямо в `plan.md` или в отдельном чек-листе.

*Связь с MVP:* Тосты (§1.4), индикатор Online/Offline (§1.4), загрузки/пустые состояния (§1.4), проверка настроек при первом запросе (§3.1) и валидация форм (§1.3) входят в обязательные или желательные требования MVP — см. раздел «MVP for Beta Testing».

---

## Feature Enhancements

Раздел описывает **улучшения существующих функций** и **новые возможности**, повышающие ценность платформы WEU AI Agent. Основан на анализе кода (`core_ui`, `agent_hub`, `tasks`, `passwords`, `servers`, `app/rag`, `app/core`, `app/mcp`, `app/tools`), документации и README.

---

### 1. Улучшения существующих функций

#### 1.1 Чат и оркестратор
- **Выбор конкретной модели (specific_model)**  
  В `chat_api` передаётся только `model` как провайдер (gemini/grok). Orchestrator уже поддерживает `specific_model`. Добавить в API и UI передачу/выбор конкретной модели (например, `gemini-2.0-flash-exp`), чтобы пользователь мог переключать модель в рамках одного провайдера без смены настроек по умолчанию.
- **Сохранение и именование диалогов**  
  История чата хранится в памяти оркестратора и теряется при перезагрузке. Добавить возможность сохранять диалоги (название, дата), загружать прошлые треды и продолжать их.
- **Экспорт/импорт истории**  
  Экспорт текущего диалога в Markdown/JSON и импорт для переноса или архива.
- **Подсказка по клавиатурным сокращениям в чате**  
  Реализовать и отображать в UI: Ctrl+P — провайдер, Ctrl+M — модель, Ctrl+R — RAG, Ctrl+Enter — отправить (упомянуто в UI Improvements, дублируем здесь как усиление чата).

#### 1.2 RAG (Knowledge Base)
- **Мультиколлекции / пространства имён**  
  Один инстанс RAG — одна коллекция. Добавить возможность создавать несколько «баз знаний» (проект, отдел, тема) и выбирать целевую при добавлении документа и при запросе из чата.
- **Метаданные и фильтрация**  
  Поддержка метаданных у документов (источник, дата, теги) и фильтрация по ним при запросе.
- **Гибридный поиск**  
  Комбинировать векторный поиск с полнотекстовым (ключевые слова), где бэкенд это допускает.
- **Версионирование документов**  
  При повторной загрузке документа с тем же источником — версионирование или замена с сохранением истории изменений (опционально).

#### 1.3 Задачи (Tasks)
- **Расширенные фильтры и поиск**  
  Фильтры по меткам, исполнителю, приоритету, дате, полю «назначено на AI», статусу выполнения AI. Полнотекстовый поиск по заголовку и описанию.
- **Массовые действия**  
  Выбор нескольких задач и смена статуса/приоритета/меток/исполнителя одним действием.
- **Шаблоны задач**  
  Сохранённые шаблоны (название, описание, метки, приоритет по умолчанию) для быстрого создания типовых задач.
- **Напоминания и дедлайны**  
  Уведомления о приближающемся дедлайне (например, за день) и визуальное выделение просроченных задач.
- **Связь «задача ↔ чат»**  
  Уже есть переход в чат с подставленной задачей (`task_id`). Дополнить: из карточки задачи — кнопка «Обсудить в чате»; в чате — отображение контекста «текущая задача» и сохранение ссылки на задачу в треде.

#### 1.4 Agent Hub
- **Пошаговый прогресс длинных операций**  
  Для запусков workflow/агентов — не только «Выполняется…», но и этапы («Шаг 2 из 5») там, где бэкенд может отдавать прогресс.
- **Повтор и отмена запусков**  
  Кнопки «Повторить» для неудачных/завершённых запусков и явная «Отмена» с подтверждением для активных.
- **Галерея workflow-шаблонов**  
  Предустановленные сценарии (например, «Code review», «Deploy») с возможностью клонирования и минимальной настройки.
- **Логи с подсветкой и копированием**  
  В модалке логов — автоскролл к концу, подсветка ошибок/предупреждений, кнопка «Скопировать весь лог».

#### 1.5 Пароли (Passwords)
- **Оценка надёжности пароля**  
  Индикатор силы пароля при создании/редактировании записи (например, по длине, символам, энтропии).
- **Напоминания о смене паролей**  
  Опциональное поле «рекомендуемая дата смены» и уведомление при приближении срока.
- **Безопасное sharing (опционально)**  
  Передача доступа к отдельной записи другому пользователю с шифрованием под его ключом и аудитом.

#### 1.6 Серверы (Servers)
- **Массовая проверка доступности**  
  Кнопка «Проверить все» / «Пинг группы» с отображением статуса по каждому серверу без поочерёдного входа.
- **Дашборд состояния**  
  Сводка: сколько серверов онлайн, последние выполненные команды, частые ошибки по группе.
- **Пул соединений**  
  Переиспользование SSH-сессий при частых командах к одному хосту, чтобы снизить задержки.

#### 1.7 MCP и инструменты
- **Подключение MCP из UI**  
  Конфигурация MCP-серверов (например, путь к `mcp_config.json` или форма в настройках) и индикация статуса «подключено / ошибка» по каждому серверу.
- **Документация инструментов в интерфейсе**  
  В оркестраторе/чате — краткое описание доступных инструментов и примеров вызова (на базе метаданных ToolManager/MCP).

---

### 2. Новые функции и возможности

#### 2.1 Управление и интеграции
- **Единая система тостов/уведомлений**  
  Глобальные уведомления об успехе/ошибке/инфо вместо только `alert()`/`confirm()`; очередь, автоскрытие, опция отключения анимаций (связано с UI Improvements).
- **Эндпоинт Health Check**  
  Лёгкий `/api/health` или `/health`: доступность Django, опционально — RAG, очередей, внешних API; использоваться для индикатора «Online/Offline» в header.
- **Журнал аудита**  
  Логирование критичных действий: вход/выход, смена настроек моделей/ключей, сброс RAG, создание/удаление задач, доступ к паролям, запуск агентов — с фильтром по пользователю и дате (только для администраторов или по ролям).
- **Управление API-ключами в настройках**  
  Сохранение ключей через UI (с шифрованием и хранением в БД или защищённом хранилище) вместо единственного варианта с `.env`, с маскировкой при отображении.

#### 2.2 Автоматизация и отчётность
- **Планировщик запусков workflow**  
  Расписание запуска workflow (cron-like или по календарю) с выбором профиля и параметров; просмотр истории запланированных и выполненных запусков.
- **Вебхуки**  
  Исходящие вебхуки при смене статуса задачи, завершении запуска агента/workflow, критичных событиях в паролях/серверах — с настраиваемым URL и подписью.
- **Интеграции с мессенджерами**  
  Уведомления в Slack/Teams (или иной канал) о назначении задачи, завершении workflow, сбоях серверов — опциональный модуль с настройкой в UI.
- **Синхронизация с Jira (опционально)**  
  Двусторонняя или односторонняя синхронизация задач с Jira: маппинг полей, периодический обмен или по кнопке.

#### 2.3 Аналитика и опыт пользователя
- **Дашборд аналитики**  
  Сводные показатели: использование чата (запросы/день), выполненные задачи по статусам, запуски агентов/workflow, использование RAG (запросы, топ документов). Экран только для администраторов или по ролям.
- **Библиотека промптов**  
  Сохранённые шаблоны промптов (название, текст, теги) для быстрой подстановки в чат и в сценарии агентов.
- **Команда и роли**  
  Расширение многопользовательности: команды/группы, роли (например, viewer, editor, admin) для разделов «Задачи», «Серверы», «Пароли», «Агенты» — с наследованием прав и общими ресурсами в рамках команды.

#### 2.4 Качество и надёжность
- **Повтор запросов к LLM**  
  При временных ошибках API (429, 5xx) — автоматический retry с экспоненциальной задержкой и ограничением числа попыток; отображение пользователю «Повтор попытки…» при необходимости.
- **Лимиты и квоты**  
  Настраиваемые лимиты на запросы к чату/RAG/агентам в единицу времени (по пользователю или по API-ключу), чтобы снизить риски перерасхода и злоупотреблений.
- **Резервное копирование конфигурации и данных**  
  Экспорт настроек моделей, списка workflow, структуры задач (без обязательной истории чата) в архив; возможность восстановления из архива — для админов.

---

### 3. Приоритизация

Рекомендуемый порядок внедрения с точки зрения ценности и трудозатрат:

1. **Быстрые победы:** specific_model в чате, Health Check, тосты, расширенные фильтры задач, «Обсудить в чате» из задачи.
2. **Средний срок:** сохранение/именование диалогов, мультиколлекции RAG, пошаговый прогресс в Agent Hub, аудит-лог, планировщик workflow.
3. **Долгий горизонт:** команды/роли, дашборд аналитики, Jira-синхронизация, вебхуки и интеграции с мессенджерами.

Фиксировать прогресс можно прямо в этом разделе (отмечать выполненное) или в отдельном чек-листе.

*Связь с MVP:* В scope беты входят: specific_model в чате (§1.1), тосты и Health Check (§2.1), «Обсудить в чате» из задачи (§1.3 — желательно). Остальные пункты — после беты. Детали см. в разделе «MVP for Beta Testing».

---

## Service Improvements

Раздел описывает **анализ текущей работы сервисов** и **предлагаемые исправления и оптимизации** для повышения надёжности и эффективности. Основан на анализе кода `core_ui/views.py`, `app/core/orchestrator.py`, `app/core/llm.py`, `app/rag/engine.py`, `app/rag/inmemory_rag.py`, `agent_hub/views.py`, `app/tools/manager.py` и `web_ui/settings.py`.

---

### 1. Надёжность (Reliability)

#### 1.1 Оркестратор — синглтон и гонки
- **Проблема:** В `core_ui/views.py` оркестратор хранится в глобальной переменной `_orchestrator`. Он создаётся в двух местах: (1) в async `get_orchestrator()` — с вызовом `await _orchestrator.initialize()`; (2) в sync `api_tools_list()` — без `initialize()`. Нет блокировки — при одновременных запросах возможна гонка; при первом запросе к списку инструментов создаётся неинициализированный экземпляр.
- **Решение:** Единая точка создания оркестратора (только через `get_orchestrator()`). Для sync-вью `api_tools_list` — либо вызывать async `get_orchestrator()` через `asyncio.run()`/другой механизм, либо вынести получение списка инструментов в отдельный синглтон ToolManager, не зависящий от оркестратора. Добавить `threading.Lock` или `asyncio.Lock` при инициализации синглтона.

#### 1.2 Таймаут запуска workflow (Agent Hub)
- **Проблема:** В `agent_hub/views.py` функция `_run_cli_stream()` использует `subprocess.Popen` и в цикле читает stdout до конца, затем `process.wait()`. Параметр `CLI_RUNTIME_TIMEOUT_SECONDS` задан в `web_ui/settings.py` (по умолчанию 600), но нигде не используется. Долгий или зависший процесс может блокировать воркер бесконечно.
- **Решение:** Ограничить время жизни процесса: использовать `process.wait(timeout=settings.CLI_RUNTIME_TIMEOUT_SECONDS)` (Python 3.3+) или обёртку с `threading.Timer`/отдельным потоком и убийством процесса по таймауту. При срабатывании таймаута — корректно завершать процесс, обновлять статус run на «failed»/«timeout» и писать в логи сообщение о таймауте.

#### 1.3 LLM — таймауты и повторы
- **Проблема:** В `app/core/llm.py`: для Gemini явный таймаут не задан (полагаемся на умолчания клиента); для Grok задан `ClientTimeout(total=60)`. При 429 (rate limit) или 5xx ответы пробрасываются пользователю без повторных попыток.
- **Решение:** Для Gemini задать явный таймаут (через опции клиента genai или обёртку `asyncio.wait_for`). Ввести retry с экспоненциальной задержкой при кодах 429 и 5xx (ограничить число попыток, например 3). В стриме при повторной попытке можно отдавать пользователю короткое сообщение вида «Повтор попытки…».

#### 1.4 RAG — подключение к Qdrant
- **Проблема:** В `app/rag/engine.py` при инициализации создаётся `QdrantClient(host=host, port=port)` без таймаута подключения и без retry. При недоступности Qdrant первый запрос к RAG может «висеть» или падать с неинформативной ошибкой.
- **Решение:** Добавить таймаут подключения и, по возможности, одну–две повторные попытки с небольшой задержкой при старте. Явно логировать переход на InMemoryRAG при недоступности Qdrant.

---

### 2. Эффективность (Efficiency)

#### 2.1 Пагинация документов RAG
- **Проблема:** В `core_ui/views.py` `rag_documents_api` вызывает `rag.get_documents(limit=limit + offset)`, затем выдаёт `documents = all_documents[offset:offset + limit]`. Для Qdrant `get_documents(limit)` возвращает не более `limit` записей и не поддерживает смещение (offset). В результате `total_count` и `has_more` основаны только на фактически полученной порции, а не на полном количестве документов. Для InMemoryRAG при вызове `get_documents(limit)` используется `get_all_documents()[:limit]`, т.е. передаваемый `limit+offset` интерпретируется как «верхняя граница количества», а не как коррекция offset — семантика пагинации размыта.
- **Решение:** Расширить RAG-движок: добавить в `get_documents(limit, offset=0)` поддержку offset там, где это возможно (Qdrant — через `scroll` с offset; InMemory — срез). Либо ввести отдельный метод `get_document_count()` и в API документов считать `total_count` по нему, а `documents` и `has_more` — по порциям с учётом offset/limit. Унифицировать поведение для Qdrant и InMemory.

#### 2.2 Первая загрузка эмбеддера (RAG)
- **Проблема:** В `app/rag/engine.py` и `inmemory_rag.py` используется общий `get_encoder()`, который при первом вызове загружает модель SentenceTransformer. Загрузка тяжёлая и блокирующая; первый запрос к RAG (add/query) может сильно задерживаться.
- **Решение:** Рассмотреть фоновую предзагрузку энкодера при старте приложения (Django startup/ASGI lifespan) или при первом обращении к RAG — в фоновом потоке/задаче, с блокировкой только тех запросов, которым реально нужен энкодер, до завершения загрузки. Либо явно документировать «холодный старт» и рекомендовать лёгкий запрос к RAG при деплое для прогрева.

#### 2.3 Загрузка файлов
- **Проблема:** В `core_ui/views.py` `api_upload_file` сохраняет файл через `for chunk in uploaded_file.chunks()`. При большом лимите (`FILE_UPLOAD_MAX_MEMORY_SIZE` 50MB) весь файл может оказаться в памяти, что даёт пики потребления при нескольких одновременных загрузках.
- **Решение:** Для файлов выше порога (например, 1–2MB) использовать потоковую запись на диск (например, `default_storage.save()` с поэтапным чтением чанков), не накапливая тело в памяти. Оставить лимит 50MB как верхнюю границу, но не держать весь объём в RAM.

---

### 3. Устойчивость и эксплуатация

#### 3.1 Health Check
- **Рекомендация:** Реализовать лёгкий эндпоинт `GET /api/health` (или `/health`): проверка работы Django (и при необходимости БД), опционально — проверка доступности RAG (пинг Qdrant или проверка `rag.available`). Использовать для индикатора «Online/Offline» в UI и для балансировщиков/мониторинга. Не включать в health тяжёлые проверки (полноценные запросы к LLM).

#### 3.2 Стриминг чата
- **Рекомендация:** Для `StreamingHttpResponse` в `chat_api` в прод-сценариях задать заголовки `Cache-Control: no-store` и, при использовании Nginx, `X-Accel-Buffering: no`, чтобы ответ не буферизовался и стрим шёл до клиента без задержек.

#### 3.3 Настройки для production
- **Рекомендация:** В `web_ui/settings.py` для production выставить `DEBUG = False`, задать `ALLOWED_HOSTS`, рассмотреть отдельные настройки БД (и пула соединений при переходе на PostgreSQL). Секреты и ключи — только из окружения или защищённого хранилища, не в коде.

---

### 4. Приоритизация изменений

1. **Высокий приоритет:** таймаут workflow (`CLI_RUNTIME_TIMEOUT_SECONDS` в `_run_cli_stream`), единая точка создания оркестратора и устранение гонки при инициализации, эндпоинт Health Check.
2. **Средний приоритет:** retry и таймауты для LLM (Gemini/Grok), корректная пагинация RAG и явный `total_count`/`has_more`.
3. **Низкий приоритет:** предзагрузка/прогрев энкодера RAG, потоковая запись больших загрузок, заголовки для стриминга и чеклист production-настроек.

Фиксировать прогресс по пунктам можно в этом разделе (отмечать выполненное) или в отдельном чек-листе.

*Связь с MVP:* Пункты «высокий приоритет» (таймаут workflow, оркестратор-синглтон, Health Check) соответствуют Must Have P0 в разделе «MVP for Beta Testing»; retry/таймауты LLM — Should Have P2.

---

## MVP for Beta Testing

Раздел задаёт **минимально жизнеспособный продукт (MVP)** для подготовки к бета-тестированию: границы функциональности, обязательные требования, приоритеты и ориентировочные сроки.

---

### 1. Цель и границы MVP

**Цель:** вывести платформу в состояние, при котором внешние бета-тестеры могут устойчиво пройти ключевые сценарии (чат, задачи, Agent Hub, RAG, базовые настройки) и оставить осмысленную обратную связь без критических сбоев.

**В scope бета-MVP:**
- Чат с оркестратором (Gemini/Grok, RAG, инструменты)
- Задачи: создание, редактирование, статусы, базовый AI-ассистент
- Agent Hub: профили, workflow, запуск и просмотр логов
- Knowledge Base: добавление документов, поиск из чата
- Настройки: API-ключи, выбор моделей, провайдер по умолчанию
- Индикация доступности системы и уведомления об успехе/ошибке

**Вне scope бета-MVP (отложить после беты):**
- Полный онбординг и Command Palette → UI Improvements §3.1, §1.1
- Мультиколлекции RAG, расширенные фильтры задач, шаблоны задач → Feature Enhancements §1.2, §1.3
- Команды/роли, дашборд аналитики, вебхуки, интеграции (Slack/Jira) → Feature Enhancements §2.3, §2.2
- Планировщик workflow, журнал аудита → Feature Enhancements §2.2, §2.1

---

### 2. Обязательные требования (Must Have)

#### 2.1 Надёжность (P0 — блокирует бету)

| № | Требование | Источник | Критерий готовности |
|---|------------|----------|---------------------|
| 1 | Таймаут запуска workflow | Service Improvements §1.2 | В `_run_cli_stream` используется `CLI_RUNTIME_TIMEOUT_SECONDS`; при срабатывании — корректное завершение процесса и статус run = failed/timeout |
| 2 | Единая точка создания оркестратора | Service Improvements §1.1 | Оркестратор создаётся только через `get_orchestrator()`; устранена гонка при одновременных запросах; sync `api_tools_list` не создаёт неинициализированный экземпляр |
| 3 | Эндпоинт Health Check | Service Improvements §3.1, Feature §2.1 | `GET /api/health` (или `/health`) возвращает статус Django и опционально RAG; используется для индикатора Online/Offline в header |

#### 2.2 UX, необходимая для беты (P1)

| № | Требование | Источник | Критерий готовности |
|---|------------|----------|---------------------|
| 4 | Глобальные тосты/уведомления | UI Improvements §1.4, Feature §2.1 | Единая система тостов (успех/ошибка/инфо) вместо только `alert()`/`confirm()`; автоскрытие, очередь |
| 5 | Индикатор Online/Offline в header | UI Improvements §1.4, §3.2 | Статус в шапке отражает результат запроса к `/api/health`; при сбоях — «Offline» или «Reconnecting» |
| 6 | Загрузки и сабмиты | UI Improvements §1.4 | У кнопок «Сохранить», «Run», «Add document», «Search» и т.п. — индикатор загрузки и блокировка повторного нажатия |
| 7 | Пустые состояния | UI Improvements §1.4 | Для пустых списков (задачи, документы KB, агенты) — короткий текст + призыв к действию («Создать задачу», «Добавить документ») |

#### 2.3 Функциональность, без которой бета бессмысленна (P1)

| № | Требование | Источник | Критерий готовности |
|---|------------|----------|---------------------|
| 8 | Выбор конкретной модели в чате (specific_model) | Feature §1.1 | В API и UI чата передаётся/выбирается конкретная модель (напр. `gemini-2.0-flash-exp`) в рамках провайдера |
| 9 | Быстрая проверка настроек при первом запросе | UI Improvements §3.1 | Если ключи не заданы или модель не выбрана — ненавязчивое уведомление со ссылкой на Settings, без блокировки интерфейса |
| 10 | Известные ограничения и «бета»-маркировка | — | Страница или блок в README/в приложении: «Бета: известные ограничения» (потеря истории чата при перезагрузке, один RAG-пространство и т.д.) |

#### 2.4 Обратная связь от тестеров (P1)

| № | Требование | Критерий готовности |
|---|------------|---------------------|
| 11 | Канал обратной связи | В UI или в документации — явная ссылка «Сообщить о проблеме» / «Предложить улучшение» (GitHub Issues, форма или email) |

---

### 3. Желательные требования (Should Have, P2)

Реализовать по возможности до старта беты; при нехватке времени допустимо отложить и включить в первые итерации по итогам беты.

| № | Требование | Источник |
|---|------------|----------|
| 12 | Retry и таймауты для LLM | Service Improvements §1.3 |
| 13 | Валидация форм в реальном времени (Settings, новая задача, KB) | UI Improvements §1.3 |
| 14 | Семантичная разметка и базовая a11y (фокус, aria-label у иконок) | UI Improvements §1.2 |
| 15 | Кнопка «Обсудить в чате» из карточки задачи + контекст задачи в чате | Feature §1.3 |

---

### 4. Приоритеты и порядок работ

- **Фаза 1 (надёжность):** пункты 1, 2, 3 — без них бета нестабильна.
- **Фаза 2 (обратная связь и маркировка):** пункты 10, 11 — без них сложно интерпретировать фидбек.
- **Фаза 3 (UX и функциональность):** пункты 4–9 — тосты, Online/Offline, загрузки, пустые состояния, specific_model, проверка настроек.
- **Фаза 4 (по остатку времени):** пункты 12–15.

Внутри фаз порядок выполнения выбирается по зависимостям (например, тосты и health — перед индикатором Online/Offline).

---

### 5. Ориентировочные сроки

| Фаза | Содержание | Оценка (рабочие дни) |
|------|------------|----------------------|
| Фаза 1 | Надёжность: таймаут workflow, оркестратор-синглтон, Health Check | 3–5 |
| Фаза 2 | Документ «Известные ограничения», канал обратной связи | 1–2 |
| Фаза 3 | Тосты, индикатор Online/Offline, индикаторы загрузки, пустые состояния, specific_model в чате, проверка настроек | 5–7 |
| Фаза 4 | Retry LLM, валидация форм, a11y, «Обсудить в чате» | 3–5 |
| Буфер и регрессия | Прогон сценариев, правки по регрессиям | 2–3 |

**Итого до готовности к бете:** ориентировочно **14–22 рабочих дня** (около **3–4,5 недель**) от старта работ по MVP.

Конкретные даты и спринты задаются при планировании (например, «Фаза 1 — до ДД.ММ», «бета-релиз — не позднее ДД.ММ»).

---

### 6. Чек-лист перед объявлением беты

Перед приглашением тестеров убедиться:

- [ ] Все пункты P0 (№1–3) выполнены и проверены.
- [ ] Выполнены пункты P1 (№4–11) или зафиксированы исключения с планом по срокам.
- [ ] Документ «Известные ограничения» актуален и доступен тестерам.
- [ ] Канал обратной связи доступен и описан в UI или в инструкции для беты.
- [ ] Пройдены основные сценарии: чат (с/без RAG), создание и редактирование задачи, запуск workflow в Agent Hub, добавление документа в KB, смена настроек моделей/провайдера.
- [ ] В production-режиме: `DEBUG = False`, заданы `ALLOWED_HOSTS` и секреты из окружения (если бета идёт не только локально).

---

### 7. Дополнительные соображения и идеи

Ниже — идеи, которые повышают согласованность плана и готовность к бете; их можно учитывать по мере реализации.

#### Риски и смягчение
- **Регрессии при правках оркестратора/LLM:** перед бетой выделить 1–2 дня на прогон основных сценариев (чат, задачи, Agent Hub, KB) после фазы 1 и фазы 3. Фиксировать сценарии в виде краткого регрессионного чек-листа рядом с §6.
- **Долгий «холодный старт» RAG:** если бета-среда перезапускается редко, первый запрос к RAG может быть медленным из-за загрузки энкодера. Варианты: прогревать RAG при старте приложения (Service §2.2) или явно описать это в «Известных ограничениях» для тестеров.
- **Одновременные запросы к оркестратору:** после введения единой точки создания (Service §1.1) имеет смысл один раз проверить сценарий «несколько вкладок / несколько запросов подряд» и при необходимости задокументировать ожидаемое поведение.

#### Улучшение процесса
- **Единый реестр задач:** вести выполнение пунктов MVP (и при желании UI/Feature/Service) в одном месте: таблица в этом файле, Issues в репозитории или доска в Notion/Jira — с пометкой «Готово / В работе / Не начато».
- **Версионирование плана:** при крупных изменениях плана сохранять дату/версию в начале документа (например, «Версия: 2025-01») и коротко фиксировать, что изменилось.
- **Критерий успеха беты:** кроме чек-листа §6 считать бету успешной, если минимум N тестеров прошли все ключевые сценарии без критических ошибок и оставили осмысленную обратную связь; число N и список сценариев можно зафиксировать при объявлении беты.

#### Идеи на будущее
- **Feature flags:** для рискованных изменений (например, новая логика оркестратора или тостов) рассмотреть простые feature flags (настройка в Django/переменная окружения), чтобы при проблемах оперативно отключать функциональность без отката кода.
- **Язык интерфейса:** в UI §3.4 указана необходимость единого языка. Для беты достаточно зафиксировать «русский по умолчанию» (или «английский») и привести ключевые экраны к одному стилю; полноценную i18n разумно планировать уже после беты.

---

Настоящий план согласован по разделам UI, Features, Service и MVP и готов к использованию в качестве основы для планирования спринтов и подготовки к бета-тестированию.
