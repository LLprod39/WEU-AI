{% extends 'base.html' %}

{% block header_title %}Настройки{% endblock %}
{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="flex items-center gap-2 text-sm min-w-0">
    <ol class="flex items-center gap-2 list-none flex-wrap" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2">
            <a href="{% url 'index' %}" class="text-gray-500 hover:text-white transition-colors" itemprop="item"><span itemprop="name">Главная</span></a>
            <meta itemprop="position" content="1">
            <span class="text-gray-600" aria-hidden="true">/</span>
        </li>
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2" aria-current="page">
            <span class="font-medium text-white" itemprop="name">Настройки</span>
            <meta itemprop="position" content="2">
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="h-full overflow-y-auto p-6">
    <div class="max-w-4xl mx-auto space-y-6">

        <!-- Header -->
        <div>
            <h1 class="text-2xl font-bold text-white" style="font-size: var(--text-2xl); font-weight: var(--font-weight-bold);">Настройки</h1>
            <p class="text-gray-400 text-sm mt-1" style="color: var(--text-secondary); font-size: var(--text-sm); margin-top: var(--spacing-xs);">API-ключи, модели, провайдеры и управление доступом.</p>
        </div>

        <div id="settings-loading" class="glass-card rounded-xl p-8 text-center text-gray-400">
            <span class="material-icons-round animate-pulse text-4xl mb-2">hourglass_empty</span>
            <p>Loading settings…</p>
        </div>

        <div id="settings-content" class="hidden space-y-6">
            <!-- API Keys -->
            <div class="glass-card rounded-xl p-6" id="tour-settings-keys" title="API-ключи задаются в .env в корне проекта — не храните их в браузере">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center">
                        <span class="material-icons-round text-amber-400">key</span>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-lg font-semibold text-white">API Keys</h2>
                        <p class="text-sm text-gray-500">Key status (configured in .env)</p>
                    </div>
                    <span class="help-badge" title="Безопасно: ключи только в .env, не в интерфейсе" aria-label="Подсказка по ключам">?</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="material-icons-round text-blue-400">auto_awesome</span>
                            <span class="font-medium text-white">Google Gemini</span>
                        </div>
                        <span id="api-gemini-status" class="text-xs font-medium px-2 py-1 rounded-lg">—</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="material-icons-round text-gray-400">smart_toy</span>
                            <span class="font-medium text-white">xAI Grok</span>
                        </div>
                        <span id="api-grok-status" class="text-xs font-medium px-2 py-1 rounded-lg">—</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="material-icons-round text-purple-400">psychology</span>
                            <span class="font-medium text-white">Anthropic Claude</span>
                        </div>
                        <span id="api-anthropic-status" class="text-xs font-medium px-2 py-1 rounded-lg">—</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="material-icons-round text-cyan-400">code</span>
                            <span class="font-medium text-white">Cursor API</span>
                        </div>
                        <span id="api-cursor-status" class="text-xs font-medium px-2 py-1 rounded-lg">—</span>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">API ключи настраиваются в файле .env в корне проекта</p>
            </div>

            <!-- Models -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center">
                        <span class="material-icons-round text-primary">memory</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Провайдеры</h2>
                        <p class="text-sm text-gray-500">Выберите основной провайдер для агентов</p>
                    </div>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">CLI Агент (провайдер)</label>
                        <select id="default-provider" class="input-field w-full md:max-w-xs" data-required="1" aria-label="Провайдер для агентов">
                            <option value="cursor">Cursor CLI (agent)</option>
                            <option value="claude">Claude CLI (claude)</option>
                            <option value="grok">Grok (в разработке)</option>
                            <option value="gemini">Gemini (в разработке)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Какой CLI агент запускать (cursor или claude)</p>
                        <span class="field-error" id="default-provider-error" style="display:none;">Required field</span>
                    </div>

                    <div id="cursor-chat-mode-row">
                        <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2" for="cursor-chat-mode">Режим Cursor Auto в чате</label>
                        <select id="cursor-chat-mode" class="input-field w-full md:max-w-xs" aria-label="Режим Cursor CLI: Ask или Agent">
                            <option value="ask">Ask — только ответы, без правки файлов</option>
                            <option value="agent">Agent — агент с правкой кода и инструментами</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Используется в чате с провайдером Cursor Auto.</p>
                    </div>

                    <div id="allow-model-selection-row" class="border-t border-white/5 pt-5">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-white mb-1" for="allow-model-selection">Разрешить выбор моделей в Workflow</label>
                                <p class="text-xs text-gray-500">Если включено — можно выбирать модель для каждого шага. Если выключено — везде используется Auto.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer ml-4">
                                <input type="checkbox" id="allow-model-selection" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2" for="internal-llm-provider">LLM для генерации workflow</label>
                        <select id="internal-llm-provider" class="input-field w-full md:max-w-xs" aria-label="Провайдер для генерации workflow">
                            <option value="grok">Grok (рекомендуется)</option>
                            <option value="gemini">Gemini</option>
                            <option value="claude">Claude</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Используется для генерации workflow и анализа задач</p>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2" for="default-orchestrator-mode">Режим выполнения Ralph</label>
                        <select id="default-orchestrator-mode" class="input-field w-full md:max-w-xs" aria-label="Как запускать Ralph workflow">
                            <option value="ralph_internal">Ralph Internal (внутри Python)</option>
                            <option value="ralph_cli">Ralph CLI (внешний binary)</option>
                            <option value="react">ReAct Loop</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ralph Internal - быстрее, Ralph CLI - через внешний binary, ReAct - классический цикл</p>
                    </div>

                    <!-- Advanced Settings (collapsed by default) -->
                    <div class="border-t border-white/10 pt-4">
                        <button type="button" onclick="toggleAdvancedSettings()" 
                            class="w-full flex items-center justify-between text-sm text-gray-400 hover:text-white transition-colors">
                            <span>Дополнительные настройки</span>
                            <span id="advanced-toggle-icon" class="material-icons-round text-sm">expand_more</span>
                        </button>
                        <div id="advanced-settings" class="hidden space-y-5 mt-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Chat Model · Gemini</label>
                                    <select id="chat-model-gemini" class="input-field w-full" data-required="1"></select>
                                    <span class="field-error" id="chat-model-gemini-error" style="display:none;">Required field</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Chat Model · Grok</label>
                                    <select id="chat-model-grok" class="input-field w-full" data-required="1"></select>
                                    <span class="field-error" id="chat-model-grok-error" style="display:none;">Required field</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Agent Model · Gemini</label>
                                    <select id="agent-model-gemini" class="input-field w-full" data-required="1"></select>
                                    <span class="field-error" id="agent-model-gemini-error" style="display:none;">Required field</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Agent Model · Grok</label>
                                    <select id="agent-model-grok" class="input-field w-full" data-required="1"></select>
                                    <span class="field-error" id="agent-model-grok-error" style="display:none;">Required field</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">RAG · Embeddings Model</label>
                                <div class="flex flex-wrap gap-2 items-center">
                                    <select id="rag-model" class="input-field flex-1 min-w-0 md:max-w-md" data-required="1"></select>
                                    <input type="text" id="rag-model-custom" placeholder="or custom model id" class="input-field flex-1 min-w-[200px] md:max-w-xs" data-required-rag="1" />
                                </div>
                                <span class="field-error" id="rag-model-error" style="display:none;">Required field</span>
                                <p class="text-xs text-gray-500 mt-1">Used for indexing and search in the knowledge base.</p>
                            </div>
                        </div>
                    </div>

                <div class="flex justify-end mt-6 pt-4 border-t border-white/5">
                    <button type="button" id="btn-save-models" class="btn-primary">
                        <span class="material-icons-round text-lg">save</span>
                        Save model settings
                    </button>
                </div>
            </div>

            <!-- Папка для файлов агента -->
            <div class="glass-card rounded-xl p-6" id="tour-agent-output-path" title="Куда сохранять код и артефакты, которые создаёт агент (workflow, чат)">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                        <span class="material-icons-round text-emerald-400">folder</span>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-lg font-semibold text-white">Папка для файлов агента</h2>
                        <p class="text-sm text-gray-500">Куда сохранять код, артефакты и результаты workflow и чата</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Папка по умолчанию</label>
                    <select id="default-agent-output-path" class="input-field w-full md:max-w-md" aria-label="Выбор папки для файлов агента">
                        <option value="">— Не задано (каждый раз выбирать вручную) —</option>
                        <option value="__load__" disabled>Загрузка…</option>
                    </select>
                    <p class="text-xs text-gray-500">Используется при создании новых workflow и быстром старте, если не указана своя папка.</p>
                </div>
                <div class="flex justify-end mt-4 pt-4 border-t border-white/5">
                    <button type="button" id="btn-save-output-path" class="btn-primary" title="Сохранить вместе с остальными настройками">
                        <span class="material-icons-round text-lg">save</span>
                        Сохранить папку
                    </button>
                </div>
            </div>

            <!-- Делегирование задач ИИ -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center">
                        <span class="material-icons-round text-primary">smart_toy</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Делегирование задач ИИ</h2>
                        <p class="text-sm text-gray-500">При делегировании задачи ИИ — куда открывать интерфейс</p>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2" for="delegate-ui">При делегировании открывать</label>
                    <select id="delegate-ui" class="input-field w-full md:max-w-md" aria-label="Чат или форма задачи при делегировании ИИ">
                        <option value="chat">Чат с контекстом задачи</option>
                        <option value="task_form">Форма задачи агента</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Используется, когда вы нажимаете «Делегировать ИИ» в уведомлении о задаче.</p>
                </div>
                <p class="text-xs text-gray-500 mt-2">Сохраняется вместе с настройками моделей (кнопка «Save model settings»).</p>
            </div>

            <!-- Session -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center">
                        <span class="material-icons-round text-red-400">history</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Session</h2>
                        <p class="text-sm text-gray-500">Chat history</p>
                    </div>
                </div>
                <button type="button" id="btn-clear-history" class="btn-ghost">
                    <span class="material-icons-round text-lg">delete_sweep</span>
                    Clear chat history
                </button>
            </div>

            <!-- Место на диске (только для пользователей с доступом к настройкам; API /api/disk/ защищён login_required + require_feature('settings')) -->
            {% if user_can_settings %}
            <div class="glass-card rounded-xl p-6" id="disk-usage-card">
                <div class="flex items-center justify-between gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-slate-500/20 flex items-center justify-center">
                            <span class="material-icons-round text-slate-400">storage</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-white">Место на диске</h2>
                            <p class="text-sm text-gray-500">Проверка свободного и занятого места по путям сервера</p>
                        </div>
                    </div>
                    <button type="button" id="btn-disk-refresh" class="btn-primary" aria-label="Обновить отчёт по диску">
                        <span class="material-icons-round text-lg">refresh</span>
                        Обновить
                    </button>
                </div>
                <div id="disk-usage-loading" class="hidden py-6 text-center text-gray-400">
                    <span class="material-icons-round animate-pulse text-3xl">hourglass_empty</span>
                    <p class="mt-2 text-sm">Загрузка…</p>
                </div>
                <div id="disk-usage-error" class="hidden py-4 px-4 rounded-xl bg-red-500/10 text-red-400 text-sm"></div>
                <div id="disk-usage-table-wrap" class="hidden overflow-x-auto">
                    <table class="w-full text-sm" aria-label="Отчёт по месту на диске">
                        <thead>
                            <tr class="border-b border-white/10 text-left text-gray-400">
                                <th class="py-3 px-3 font-medium">Путь</th>
                                <th class="py-3 px-3 font-medium">Занято</th>
                                <th class="py-3 px-3 font-medium">Свободно</th>
                                <th class="py-3 px-3 font-medium">Использовано %</th>
                            </tr>
                        </thead>
                        <tbody id="disk-usage-tbody"></tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Управление доступом — одна страница с вкладками -->
            {% if user_can_settings %}
            <div class="glass-card rounded-xl p-6 border border-primary/20 shadow-glow-primary">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex items-start gap-3">
                        <div class="w-11 h-11 rounded-xl bg-primary/20 flex items-center justify-center ring-2 ring-primary/30 shrink-0">
                            <span class="material-icons-round text-primary text-xl" aria-hidden="true">manage_accounts</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-white">Управление доступом</h2>
                            <p class="text-sm text-gray-400 mt-0.5">Пользователи, группы и права к разделам — всё в одном разделе с вкладками.</p>
                        </div>
                    </div>
                    <a href="{% url 'settings_access' %}" class="btn-primary inline-flex items-center justify-center gap-2 shrink-0 self-start sm:self-center" aria-label="Открыть управление доступом">
                        <span class="material-icons-round text-lg" aria-hidden="true">open_in_full</span>
                        Открыть
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- About -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center">
                        <span class="material-icons-round text-cyan-400">info</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">About</h2>
                        <p class="text-sm text-gray-500">Version and stack</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="p-3 bg-white/5 rounded-lg">
                        <div class="text-gray-500 text-xs mb-1">Version</div>
                        <div class="text-white font-medium">1.0.0</div>
                    </div>
                    <div class="p-3 bg-white/5 rounded-lg">
                        <div class="text-gray-500 text-xs mb-1">Framework</div>
                        <div class="text-white font-medium">Django 5.x</div>
                    </div>
                    <div class="p-3 bg-white/5 rounded-lg">
                        <div class="text-gray-500 text-xs mb-1">Agent pattern</div>
                        <div class="text-white font-medium">ReAct</div>
                    </div>
                    <div class="p-3 bg-white/5 rounded-lg">
                        <div class="text-gray-500 text-xs mb-1">RAG</div>
                        <div class="text-white font-medium">Qdrant / InMemory</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% load static %}
<script src="{% static 'js/validate.js' %}"></script>
<script>
(function() {
    var getCookie = window.getCookie || function() { return null; };
    var showToast = window.showToast || function() {};

    if (window.SettingsValidation) {
        window.SettingsValidation.setOptions({
            apiKeyIds: [],
            requiredFieldIds: [['default-provider','default-provider-error']],
            rag: { selId: 'rag-model', customId: 'rag-model-custom', errId: 'rag-model-error' }
        });
    }

    function fillSelect(id, options, value) {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '';
        const added = new Set();
        options.forEach(function(opt) {
            const v = typeof opt === 'string' ? opt : (opt.value !== undefined ? opt.value : opt.id);
            if (added.has(v)) return;
            added.add(v);
            const o = document.createElement('option');
            o.value = v;
            o.textContent = typeof opt === 'string' ? opt : (opt.label || opt.name || v);
            if (String(v) === String(value)) o.selected = true;
            sel.appendChild(o);
        });
        if (value && !added.has(value)) {
            const o = document.createElement('option');
            o.value = value;
            o.textContent = value + ' (current)';
            o.selected = true;
            sel.insertBefore(o, sel.firstChild);
        }
    }

    var loadSettings = async function() {
        const loading = document.getElementById('settings-loading');
        const content = document.getElementById('settings-content');
        try {
            const [settingsRes, modelsRes] = await Promise.all([
                fetch('/api/settings/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } }),
                fetch('/api/models/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            ]);
            const settings = await settingsRes.json();
            const models = await modelsRes.json();

            if (!settings.success) throw new Error(settings.error || 'Failed to load settings');
            if (models.error) throw new Error(models.error || 'Failed to load models');

            const cfg = settings.config || {};
            const apiKeys = settings.api_keys || {};
            const cur = models.current || {};
            const gemini = models.gemini || [];
            const grok = models.grok || [];
            const ragDefaults = models.rag_defaults || ['models/text-embedding-004'];

            // API status
            const geminiStatus = document.getElementById('api-gemini-status');
            const grokStatus = document.getElementById('api-grok-status');
            const anthropicStatus = document.getElementById('api-anthropic-status');
            const cursorStatus = document.getElementById('api-cursor-status');
            
            if (geminiStatus) {
                geminiStatus.textContent = apiKeys.gemini_set ? 'Configured' : 'Not set';
                geminiStatus.className = 'text-xs font-medium px-2 py-1 rounded-lg ' + (apiKeys.gemini_set ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400');
            }
            if (grokStatus) {
                grokStatus.textContent = apiKeys.grok_set ? 'Configured' : 'Not set';
                grokStatus.className = 'text-xs font-medium px-2 py-1 rounded-lg ' + (apiKeys.grok_set ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400');
            }
            if (anthropicStatus) {
                anthropicStatus.textContent = apiKeys.anthropic_set ? 'Configured' : 'Not set';
                anthropicStatus.className = 'text-xs font-medium px-2 py-1 rounded-lg ' + (apiKeys.anthropic_set ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400');
            }
            if (cursorStatus) {
                cursorStatus.textContent = apiKeys.cursor_set ? 'Configured' : 'Not set';
                cursorStatus.className = 'text-xs font-medium px-2 py-1 rounded-lg ' + (apiKeys.cursor_set ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400');
            }

            // Основной провайдер
            const defProvider = document.getElementById('default-provider');
            if (defProvider) {
                let provider = cfg.default_provider || 'cursor';
                // Если сохранено "auto" или "ralph" - исправляем на cursor
                if (provider === 'auto' || provider === 'ralph') {
                    provider = 'cursor';
                }
                defProvider.value = provider;
            }

            // Режим Cursor CLI в чате (Ask / Agent)
            const cursorMode = document.getElementById('cursor-chat-mode');
            if (cursorMode) cursorMode.value = (cfg.cursor_chat_mode || 'ask') === 'agent' ? 'agent' : 'ask';

            // Разрешить выбор моделей в Workflow
            const allowModelSelection = document.getElementById('allow-model-selection');
            if (allowModelSelection) {
                allowModelSelection.checked = cfg.allow_model_selection === true;
                // Сохраняем в localStorage для доступа из agent_hub.js
                localStorage.setItem('weu_allow_model_selection', allowModelSelection.checked ? '1' : '0');
            }

            // LLM для внутренних задач
            const internalLlm = document.getElementById('internal-llm-provider');
            if (internalLlm) internalLlm.value = cfg.internal_llm_provider || 'grok';

            // Режим оркестратора Ralph
            const orchestratorMode = document.getElementById('default-orchestrator-mode');
            if (orchestratorMode) orchestratorMode.value = cfg.default_orchestrator_mode || 'ralph_internal';

            // Делегирование задач ИИ
            const delegateUi = document.getElementById('delegate-ui');
            if (delegateUi) delegateUi.value = (cfg.delegate_ui === 'task_form') ? 'task_form' : 'chat';

            // Папка для файлов агента: загрузка списка проектов
            const outputPathSel = document.getElementById('default-agent-output-path');
            if (outputPathSel) {
                try {
                    const projRes = await fetch('/agents/api/projects/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const projData = await projRes.json();
                    const projects = (projData.projects || []).slice();
                    const loadOpt = outputPathSel.querySelector('option[value="__load__"]');
                    if (loadOpt) loadOpt.remove();
                    const firstOpt = outputPathSel.querySelector('option[value=""]');
                    projects.forEach(function(p) {
                        const o = document.createElement('option');
                        o.value = (p.path || p.name || '');
                        o.textContent = (p.name || p.path || '') + (p.full_path ? ' — ' + p.full_path : '');
                        if (firstOpt && firstOpt.nextSibling) outputPathSel.insertBefore(o, firstOpt.nextSibling);
                        else outputPathSel.appendChild(o);
                    });
                    outputPathSel.value = (cfg.default_agent_output_path || '').trim();
                } catch (e) {
                    const loadOpt = outputPathSel.querySelector('option[value="__load__"]');
                    if (loadOpt) { loadOpt.value = ''; loadOpt.textContent = '— Ошибка загрузки списка —'; loadOpt.disabled = false; }
                }
            }

            // Chat / Agent selects: use lists from API, preserve current value
            fillSelect('chat-model-gemini', gemini, cfg.chat_model_gemini || cur.chat_gemini);
            fillSelect('chat-model-grok', grok, cfg.chat_model_grok || cur.chat_grok);
            fillSelect('agent-model-gemini', gemini, cfg.agent_model_gemini || cur.agent_model_gemini);
            fillSelect('agent-model-grok', grok, cfg.agent_model_grok || cur.agent_model_grok);
            fillSelect('rag-model', ragDefaults, cfg.rag_model || cur.rag_model);
            const ragCustom = document.getElementById('rag-model-custom');
            if (ragCustom && (cfg.rag_model || cur.rag_model)) {
                const r = cfg.rag_model || cur.rag_model;
                if (ragDefaults.indexOf(r) === -1) ragCustom.value = r;
            }

            loading.classList.add('hidden');
            content.classList.remove('hidden');
        } catch (e) {
            loading.classList.add('hidden');
            content.classList.remove('hidden');
            showToast('Load error: ' + (e.message || e), 'error');
        }
    };

    var saveSettings = async function() {
        if (!(window.SettingsValidation && window.SettingsValidation.validateAllRequired())) return;
        const btn = document.getElementById('btn-save-models');
        if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; }
        const ragCustom = document.getElementById('rag-model-custom');
        const ragVal = (ragCustom && ragCustom.value.trim()) ? ragCustom.value.trim() : document.getElementById('rag-model').value;
        const payload = {
            default_provider: (document.getElementById('default-provider') && document.getElementById('default-provider').value) || 'cursor',
            chat_model_gemini: document.getElementById('chat-model-gemini').value,
            chat_model_grok: document.getElementById('chat-model-grok').value,
            agent_model_gemini: document.getElementById('agent-model-gemini').value,
            agent_model_grok: document.getElementById('agent-model-grok').value,
            rag_model: ragVal,
            default_agent_output_path: (document.getElementById('default-agent-output-path') && document.getElementById('default-agent-output-path').value) || '',
            cursor_chat_mode: (document.getElementById('cursor-chat-mode') && document.getElementById('cursor-chat-mode').value) || 'ask',
            internal_llm_provider: (document.getElementById('internal-llm-provider') && document.getElementById('internal-llm-provider').value) || 'grok',
            default_orchestrator_mode: (document.getElementById('default-orchestrator-mode') && document.getElementById('default-orchestrator-mode').value) || 'ralph_internal',
            delegate_ui: (document.getElementById('delegate-ui') && document.getElementById('delegate-ui').value) || 'chat',
            allow_model_selection: document.getElementById('allow-model-selection') ? document.getElementById('allow-model-selection').checked : false
        };
        // Сохраняем в localStorage для agent_hub.js
        localStorage.setItem('weu_allow_model_selection', payload.allow_model_selection ? '1' : '0');
        try {
            const r = await fetch('/api/settings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(payload)
            });
            var data = await r.json();
            if (data.success) showToast('Settings saved', 'success');
            else showToast('Error: ' + (data.error || 'failed to save'), 'error');
        } catch (e) {
            showToast('Error: ' + (e.message || e), 'error');
        } finally {
            if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; }
        }
    };

    var clearHistory = async function() {
        if (!confirm('Clear all chat history?')) return;
        const btn = document.getElementById('btn-clear-history');
        if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; }
        try {
            const r = await fetch('/api/clear-history/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            var data = await r.json();
            if (data.success) showToast('History cleared', 'success');
            else showToast('Error: ' + (data.error || 'failed to clear'), 'error');
        } catch (e) {
            showToast('Error: ' + (e.message || e), 'error');
        } finally {
            if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; }
        }
    }

    // Место на диске: запрос /api/disk/ и отображение таблицы (только для user_can_settings)
    var loadDiskUsage = async function() {
        var card = document.getElementById('disk-usage-card');
        if (!card) return;
        var loading = document.getElementById('disk-usage-loading');
        var errorEl = document.getElementById('disk-usage-error');
        var tableWrap = document.getElementById('disk-usage-table-wrap');
        var tbody = document.getElementById('disk-usage-tbody');
        var btnRefresh = document.getElementById('btn-disk-refresh');
        if (loading) loading.classList.remove('hidden');
        if (errorEl) { errorEl.classList.add('hidden'); errorEl.textContent = ''; }
        if (tableWrap) tableWrap.classList.add('hidden');
        if (tbody) tbody.innerHTML = '';
        if (btnRefresh) { btnRefresh.disabled = true; btnRefresh.classList.add('btn-loading'); }
        try {
            var r = await fetch('/api/disk/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            var data = await r.json();
            if (loading) loading.classList.add('hidden');
            if (!r.ok) {
                if (errorEl) {
                    errorEl.textContent = data.error || 'Ошибка загрузки отчёта по диску (HTTP ' + r.status + ')';
                    errorEl.classList.remove('hidden');
                }
                return;
            }
            var paths = data.paths || [];
            if (paths.length === 0 && data.error) {
                if (errorEl) {
                    errorEl.textContent = data.error;
                    errorEl.classList.remove('hidden');
                }
                return;
            }
            paths.forEach(function(entry) {
                var tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5';
                var pathLabel = entry.label || entry.path || '—';
                var usedHuman = entry.error ? '—' : (entry.used_human || '—');
                var freeHuman = entry.error ? '—' : (entry.free_human || '—');
                var pct = entry.error ? '—' : (entry.percent_used != null ? entry.percent_used + '%' : '—');
                if (entry.error) {
                    tr.innerHTML = '<td class="py-3 px-3 text-gray-300" colspan="4">' + pathLabel + ' <span class="text-red-400 text-xs">(' + (entry.error || '') + ')</span></td>';
                } else {
                    tr.innerHTML = '<td class="py-3 px-3 text-gray-300 font-mono text-xs">' + pathLabel + '</td><td class="py-3 px-3 text-white">' + usedHuman + '</td><td class="py-3 px-3 text-white">' + freeHuman + '</td><td class="py-3 px-3 text-white">' + pct + '</td>';
                }
                if (tbody) tbody.appendChild(tr);
            });
            if (tableWrap && paths.length > 0) tableWrap.classList.remove('hidden');
        } catch (e) {
            if (loading) loading.classList.add('hidden');
            if (errorEl) {
                errorEl.textContent = 'Не удалось загрузить отчёт: ' + (e.message || String(e));
                errorEl.classList.remove('hidden');
            }
        } finally {
            if (btnRefresh) { btnRefresh.disabled = false; btnRefresh.classList.remove('btn-loading'); }
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        if (window.SettingsValidation && window.SettingsValidation.setupValidation) window.SettingsValidation.setupValidation();
        
        // Обработчик для переключателя моделей - сразу сохраняем в localStorage
        var allowModelSel = document.getElementById('allow-model-selection');
        if (allowModelSel) {
            allowModelSel.addEventListener('change', function() {
                localStorage.setItem('weu_allow_model_selection', this.checked ? '1' : '0');
            });
        }
        // Кнопка «Обновить» для места на диске (блок виден только при user_can_settings)
        var btnDiskRefresh = document.getElementById('btn-disk-refresh');
        if (btnDiskRefresh) btnDiskRefresh.addEventListener('click', loadDiskUsage);
    });
    var btnSave = document.getElementById('btn-save-models');
    if (btnSave) btnSave.addEventListener('click', saveSettings);
    var btnSavePath = document.getElementById('btn-save-output-path');
    if (btnSavePath) btnSavePath.addEventListener('click', saveSettings);
    const btnClear = document.getElementById('btn-clear-history');
    if (btnClear) btnClear.addEventListener('click', clearHistory);
    
    // Toggle advanced settings
    window.toggleAdvancedSettings = function() {
        const advSettings = document.getElementById('advanced-settings');
        const toggleIcon = document.getElementById('advanced-toggle-icon');
        if (advSettings && toggleIcon) {
            if (advSettings.classList.contains('hidden')) {
                advSettings.classList.remove('hidden');
                toggleIcon.textContent = 'expand_less';
            } else {
                advSettings.classList.add('hidden');
                toggleIcon.textContent = 'expand_more';
            }
        }
    };
})();
</script>
{% endblock %}
