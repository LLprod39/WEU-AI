{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}WEU AI Agent{% endblock %}</title>
    <meta name="description" content="Enterprise AI Agent with RAG, Tools, and Orchestration">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Consolas', 'monospace'],
                    },
                    colors: {
                        bg: {
                            deep: '#050507',
                            base: '#09090b',
                            surface: '#111113',
                            elevated: '#18181b',
                        },
                        border: {
                            subtle: 'rgba(255, 255, 255, 0.06)',
                            DEFAULT: 'rgba(255, 255, 255, 0.1)',
                            strong: 'rgba(255, 255, 255, 0.15)',
                        },
                        primary: {
                            DEFAULT: '#6366f1',
                            hover: '#4f46e5',
                            light: '#818cf8',
                            dark: '#4338ca',
                        },
                        accent: '#06b6d4',
                    },
                    boxShadow: {
                        'glow-primary': '0 0 20px rgba(99, 102, 241, 0.3)',
                        'glow-primary-lg': '0 0 40px rgba(99, 102, 241, 0.4)',
                        'glow-success': '0 0 15px rgba(34, 197, 94, 0.4)',
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out',
                        'fade-in-up': 'fade-in-up 0.4s ease-out',
                        'slide-in-right': 'slide-in-right 0.3s ease-out',
                        'scale-in': 'scale-in 0.2s ease-out',
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'slide-in-right': {
                            '0%': { opacity: '0', transform: 'translateX(10px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        'scale-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                    },
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    
    <!-- Theme, density and motion are defined in style.css -->
</head>

<body class="bg-bg-base text-gray-100 font-sans antialiased overflow-hidden h-screen flex noise-overlay {% block body_extra_class %}{% endblock %}" data-theme="dark" data-density="normal" data-size="normal">

    <!-- Skip to main content (A11Y) -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- Aurora Background -->
    <div class="aurora-bg">
        <div class="aurora-blob aurora-blob-1"></div>
        <div class="aurora-blob aurora-blob-2"></div>
        <div class="aurora-blob aurora-blob-3"></div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar glass-md border-r border-white/5 flex flex-col z-20 relative">

        <!-- Brand -->
        <div class="flex items-center px-5 border-b border-white/5 gap-3" style="height: var(--header-height); padding: var(--spacing-md) var(--spacing-lg);">
            <div
                class="w-9 h-9 rounded-xl bg-primary/20 border border-primary/30 flex items-center justify-center shadow-glow-primary flex-shrink-0" aria-hidden="true">
                <span class="material-icons-round text-primary text-xl" aria-hidden="true">auto_awesome</span>
            </div>
            <div class="flex flex-col flex-1 min-w-0">
                <span class="font-bold tracking-tight text-white text-base">WEU AI</span>
                <span class="text-[10px] text-gray-500 -mt-0.5">Enterprise Agent</span>
            </div>
            <button type="button" id="sidebar-toggle" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition-colors flex-shrink-0" aria-label="Collapse sidebar" title="Collapse sidebar">
                <span class="sidebar-toggle-icon icon-expand material-icons-round text-lg" aria-hidden="true">chevron_left</span>
                <span class="sidebar-toggle-icon icon-collapse material-icons-round text-lg" aria-hidden="true">menu</span>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto" style="padding: var(--spacing-md);" aria-label="Main">
            <div class="space-y-1">
            <div class="px-3 py-2 text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Core</div>
            <a href="{% url 'index' %}" class="sidebar-link {% if request.path == '/' %}active{% endif %}" aria-label="Chat">
                <span class="material-icons-round text-lg {% if request.path == '/' %}text-primary{% endif %}" aria-hidden="true">chat</span>
                <span class="nav-text">Chat</span>
            </a>
            <a href="{% url 'orchestrator' %}" class="sidebar-link {% if 'orchestrator' in request.path %}active{% endif %}" aria-label="Orchestrator">
                <span class="material-icons-round text-lg {% if 'orchestrator' in request.path %}text-primary{% endif %}" aria-hidden="true">account_tree</span>
                <span class="nav-text">Orchestrator</span>
            </a>
            <a href="{% url 'agent_hub:agents_page' %}" class="sidebar-link {% if 'agents' in request.path %}active{% endif %}" aria-label="Agents">
                <span class="material-icons-round text-lg {% if 'agents' in request.path %}text-primary{% endif %}" aria-hidden="true">hub</span>
                <span class="nav-text">Agents</span>
            </a>

            <div class="px-3 py-2 mt-4 text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Automation</div>
            <a href="{% url 'tasks:task_list' %}" class="sidebar-link {% if 'tasks' in request.path %}active{% endif %}" aria-label="Tasks">
                <span class="material-icons-round text-lg {% if 'tasks' in request.path %}text-primary{% endif %}" aria-hidden="true">check_circle</span>
                <span class="nav-text">Tasks</span>
            </a>

            <div class="px-3 py-2 mt-4 text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Data</div>
            <a href="{% url 'knowledge_base' %}" class="sidebar-link {% if 'knowledge' in request.path %}active{% endif %}" aria-label="Knowledge Base">
                <span class="material-icons-round text-lg {% if 'knowledge' in request.path %}text-primary{% endif %}" aria-hidden="true">storage</span>
                <span class="nav-text">Knowledge Base</span>
            </a>

            <div class="px-3 py-2 mt-4 text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Tools</div>
            <a href="{% url 'servers:server_list' %}" class="sidebar-link {% if 'servers' in request.path %}active{% endif %}" aria-label="Servers">
                <span class="material-icons-round text-lg {% if 'servers' in request.path %}text-primary{% endif %}" aria-hidden="true">terminal</span>
                <span class="nav-text">Servers</span>
            </a>
            <a href="{% url 'passwords:password_list' %}" class="sidebar-link {% if 'passwords' in request.path %}active{% endif %}" aria-label="Passwords">
                <span class="material-icons-round text-lg {% if 'passwords' in request.path %}text-primary{% endif %}" aria-hidden="true">lock</span>
                <span class="nav-text">Passwords</span>
            </a>

            <div class="px-3 py-2 mt-4 text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Admin</div>
            <a href="{% url 'settings' %}" class="sidebar-link {% if 'settings' in request.path %}active{% endif %}" aria-label="Settings">
                <span class="material-icons-round text-lg {% if 'settings' in request.path %}text-primary{% endif %}" aria-hidden="true">settings</span>
                <span class="nav-text">Settings</span>
            </a>
            </div>
        </nav>

        <!-- User Profile -->
        <div class="border-t border-white/5" style="padding: var(--spacing-md);">
            <form action="{% url 'logout' %}" method="post">
                {% csrf_token %}
                <button type="submit"
                    class="w-full flex items-center gap-3 p-2.5 rounded-xl hover:bg-white/5 transition-all group">
                    <div
                        class="w-9 h-9 rounded-full bg-gradient-to-br from-primary to-purple-500 flex items-center justify-center text-xs font-bold text-white shadow-lg">
                        {{ request.user.username|slice:":2"|upper }}
                    </div>
                    <div class="flex flex-col items-start flex-1">
                        <span class="text-sm font-medium text-white">{{ request.user.username }}</span>
                        <span class="text-[10px] text-gray-500 group-hover:text-red-400 transition-colors">Sign
                            Out</span>
                    </div>
                    <span
                        class="material-icons-round text-gray-600 text-lg group-hover:text-red-400 transition-colors" aria-hidden="true">logout</span>
                </button>
            </form>
        </div>
    </aside>

    <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 flex flex-col relative overflow-hidden" tabindex="-1">

        <!-- Header -->
        <header
            class="border-b border-white/5 glass-sm flex items-center justify-between px-6 z-10 relative transition-base" style="height: var(--header-height);">
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <button class="mobile-menu-btn" id="mobile-menu-btn" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="sidebar"><i class="material-icons-round" aria-hidden="true">menu</i></button>
                {% block breadcrumbs %}
                <nav aria-label="Breadcrumb" class="flex items-center gap-2 text-sm min-w-0">
                    <ol class="flex items-center gap-2 list-none flex-wrap" itemscope itemtype="https://schema.org/BreadcrumbList">
                        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2">
                            <a href="{% url 'index' %}" class="text-gray-500 hover:text-white transition-colors truncate" itemprop="item"><span itemprop="name">Home</span></a>
                            <meta itemprop="position" content="1">
                            <span class="text-gray-600" aria-hidden="true">/</span>
                        </li>
                        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2 truncate" aria-current="page">
                            <span class="font-medium text-white truncate" itemprop="name">{% block header_title %}Dashboard{% endblock %}</span>
                            <meta itemprop="position" content="2">
                        </li>
                    </ol>
                </nav>
                {% endblock %}
            </div>

            <div class="flex items-center gap-2 flex-shrink-0">
                <a href="#" id="help-trigger" class="header-quick-action" aria-label="Help: articles and repeat tour" title="Справка: статьи и повтор тура" onclick="toggleHelpPanel(); return false;">
                    <span class="material-icons-round text-lg" aria-hidden="true">help_outline</span>
                    <span class="hidden sm:inline text-xs">Help</span>
                </a>
                <a href="https://github.com/your-org/web_rA/issues" target="_blank" rel="noopener noreferrer" class="header-quick-action" aria-label="Feedback" title="Feedback">
                    <span class="material-icons-round text-lg" aria-hidden="true">feedback</span>
                    <span class="hidden sm:inline text-xs">Feedback</span>
                </a>
                <a href="#" class="header-quick-action" id="header-status-link" aria-label="System status" title="Status" onclick="return false;">
                    <span id="connection-status" class="status-badge status-online inline-flex items-center gap-1.5">
                        <span class="status-dot" aria-hidden="true"></span>
                        <span>Status</span>
                    </span>
                </a>
                <div id="header-model-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/5 text-xs cursor-pointer hover:bg-white/10 transition-colors"
                    role="button" tabindex="0" aria-label="Текущая модель, перейти в настройки"
                    onclick="var u=document.getElementById('header-model-badge'); if(u&&u.dataset.href){ window.location.href=u.dataset.href; } else { window.location.href='{% url 'settings' %}'; }"
                    onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); var u=document.getElementById('header-model-badge'); if(u&&u.dataset.href) window.location.href=u.dataset.href; else window.location.href='{% url 'settings' %}'; }"
                    data-href="{% url 'settings' %}">
                    <span class="material-icons-round text-sm text-primary" aria-hidden="true">memory</span>
                    <span id="header-current-model" class="text-gray-300 font-medium truncate max-w-[140px]">—</span>
                    <span class="material-icons-round text-xs text-gray-500" aria-hidden="true">settings</span>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="flex-1 overflow-hidden z-10 relative">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- UI settings panel (dialog, no focus trap) -->
    <div id="ui-settings-panel" class="ui-settings-panel" role="dialog" aria-label="UI Settings" aria-modal="true" aria-hidden="true">
        <div class="ui-settings-header">
            <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                <span class="material-icons-round text-primary" aria-hidden="true">tune</span>
                UI Settings
            </h2>
            <button type="button" onclick="toggleUISettings()" class="btn-ghost p-2" aria-label="Close UI settings panel">
                <span class="material-icons-round text-lg" aria-hidden="true">close</span>
            </button>
        </div>

        <!-- Theme -->
        <div class="ui-settings-section">
            <div class="ui-settings-section-title">Theme</div>
            <div class="ui-settings-option">
                <div class="ui-settings-label">Color scheme</div>
                <div class="ui-settings-control">
                    <select id="theme-select" class="ui-select" onchange="changeTheme(this.value)">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Density -->
        <div class="ui-settings-section">
            <div class="ui-settings-section-title">Density</div>
            <div class="ui-settings-option">
                <div class="ui-settings-label">Element size</div>
                <div class="ui-settings-control">
                    <select id="density-select" class="ui-select" onchange="changeDensity(this.value)">
                        <option value="compact">Compact</option>
                        <option value="normal" selected>Normal</option>
                        <option value="spacious">Spacious</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Size -->
        <div class="ui-settings-section">
            <div class="ui-settings-section-title">Size</div>
            <div class="ui-settings-option">
                <div class="ui-settings-label">Scale</div>
                <div class="ui-settings-control">
                    <select id="size-select" class="ui-select" onchange="changeSize(this.value)">
                        <option value="small">Small</option>
                        <option value="normal" selected>Normal</option>
                        <option value="large">Large</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Animations -->
        <div class="ui-settings-section">
            <div class="ui-settings-section-title">Animations</div>
            <div class="ui-settings-option">
                <div class="ui-settings-label">Enable animations</div>
                <div class="ui-settings-control">
                    <div class="ui-toggle-switch active" onclick="toggleAnimations(this)">
                        <input type="checkbox" checked style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Reset -->
        <div class="ui-settings-section">
            <button onclick="resetUISettings()" class="btn-ghost w-full justify-center" aria-label="Reset UI settings">
                <span class="material-icons-round text-lg" aria-hidden="true">refresh</span>
                Reset settings
            </button>
        </div>
    </div>

    <!-- UI settings toggle button -->
    <button type="button" id="ui-settings-toggle" class="ui-settings-toggle-btn" onclick="toggleUISettings()" title="UI Settings" aria-label="Open UI settings" aria-expanded="false" aria-controls="ui-settings-panel">
        <span class="material-icons-round text-2xl" aria-hidden="true">tune</span>
    </button>

    <!-- Toast container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Help panel (right drawer, no focus trap) -->
    <div id="help-panel" class="help-panel" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Справка: статьи и повтор тура">
        <div class="help-panel-header">
            <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                <span class="material-icons-round text-primary" aria-hidden="true">help_outline</span>
                Справка
            </h2>
            <button type="button" onclick="toggleHelpPanel()" class="btn-ghost p-2" aria-label="Закрыть справку">
                <span class="material-icons-round text-lg" aria-hidden="true">close</span>
            </button>
        </div>
        <div class="help-panel-body">
            <button type="button" class="help-repeat-tour" onclick="if(window.OnboardingTour){window.OnboardingTour.start(true);toggleHelpPanel();}" aria-label="Запустить обучение с начала">
                <span class="material-icons-round" aria-hidden="true">tour</span>
                Повторить тур
            </button>
            <h2 style="font-size: var(--text-base); margin-top: 0;">Статьи</h2>
            <article class="help-article">
                <h3>Что такое RAG</h3>
                <p>RAG (Retrieval-Augmented Generation) — это режим, при котором ответы модели подкрепляются поиском по вашей базе знаний. Вы загружаете документы в Knowledge Base, включаете «RAG Enabled» в чате — и ответы опираются на эти документы. Удобно для внутренних регламентов, базы знаний компании, документации.</p>
            </article>
            <article class="help-article">
                <h3>Что такое Workflow</h3>
                <p>Workflow (Orchestrator) — цепочка «ввод → анализ → действие инструментами → ответ». Агент планирует шаги, вызывает инструменты (файлы, SSH, веб) и формирует итоговый ответ. В разделе Orchestrator отображаются доступные инструменты и статус; Agents — готовые агенты и запуск воркфлоу по задачам.</p>
            </article>
            <article class="help-article">
                <h3>Как выбрать модель</h3>
                <p>В чате выберите провайдер (Gemini/Grok) и модель. Более мощные модели (например, Pro) точнее в сложных рассуждениях; Flash — быстрее и дешевле. В Settings задаётся модель по умолчанию и модели для агента и RAG-эмбеддингов.</p>
            </article>
            <article class="help-article">
                <h3>Как безопасно подключать сервер</h3>
                <p>Подключение к серверам задаётся в разделе Servers. Используйте ключи (SSH) и учётные данные из раздела Passwords — не вводите пароли в чат. Ограничьте права пользователя на сервере и храните ключи только в защищённом хранилище (.env, менеджер паролей), не в коде и не в чате.</p>
            </article>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="{% static 'js/toast.js' %}"></script>
    <script src="{% static 'js/common.js' %}"></script>
    <script src="{% static 'js/app_shell.js' %}"></script>
    <script src="{% static 'js/onboarding.js' %}"></script>
    <script>
    function toggleHelpPanel() {
        var p = document.getElementById('help-panel');
        if (p) {
            p.classList.toggle('open');
            p.setAttribute('aria-hidden', p.classList.contains('open') ? 'false' : 'true');
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        if (window.OnboardingTour && window.OnboardingTour.shouldShowAfterLogin && window.OnboardingTour.shouldShowAfterLogin()) {
            window.OnboardingTour.start(true);
        }
        document.addEventListener('click', function(e) {
            var hp = document.getElementById('help-panel');
            var ht = document.getElementById('help-trigger');
            if (hp && hp.classList.contains('open') && !hp.contains(e.target) && ht && !ht.contains(e.target)) {
                hp.classList.remove('open');
                hp.setAttribute('aria-hidden', 'true');
            }
        });
    });
    </script>

    {% block scripts %}{% endblock %}
</body>

</html>