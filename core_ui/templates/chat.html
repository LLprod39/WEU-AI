{% extends 'base.html' %}

{% block header_title %}Chat{% endblock %}
{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="flex items-center gap-2 text-sm min-w-0">
    <ol class="flex items-center gap-2 list-none flex-wrap" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2">
            <a href="{% url 'index' %}" class="text-gray-500 hover:text-white transition-colors" itemprop="item"><span itemprop="name">Home</span></a>
            <meta itemprop="position" content="1">
            <span class="text-gray-600" aria-hidden="true">/</span>
        </li>
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2" aria-current="page">
            <span class="font-medium text-white" itemprop="name">Chat</span>
            <meta itemprop="position" content="2">
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full relative corporate-chat-container">

    <!-- Chat Messages Container -->
    <div id="chat-container" class="flex-1 overflow-y-auto scroll-smooth px-8 md:px-16 lg:px-24 py-10 space-y-6 pb-64 corporate-chat-messages">

        <!-- Welcome Message -->
        <div id="welcome-message"
            class="flex flex-col items-center justify-center pt-24 pb-16 text-center animate-fade-in-up max-w-5xl mx-auto">
            <div class="relative mb-10">
                <div
                    class="w-28 h-28 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/10 border border-primary/30 flex items-center justify-center shadow-xl shadow-primary/10">
                    <span class="material-icons-round text-7xl text-primary">support_agent</span>
                </div>
                <div
                    class="absolute -bottom-3 -right-3 w-8 h-8 rounded-full bg-emerald-500 border-2 border-bg-base flex items-center justify-center shadow-lg">
                    <span class="material-icons-round text-xs text-white">check</span>
                </div>
            </div>

            <h1 class="text-5xl font-bold text-white mb-5 tracking-tight">
                Enterprise AI Assistant
            </h1>
            <p class="text-gray-400 text-sm mb-2">Ask questions, run tools, and get things done.</p>
            <p class="text-gray-300 max-w-2xl mb-12 leading-relaxed text-lg font-light">
                Professional AI-powered assistant for document analysis, web research, SSH operations, and complex task execution.
            </p>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-5xl w-full">
                <button class="corporate-action-btn group" onclick="insertPrompt('Search the web for latest AI news')">
                    <div class="corporate-action-icon bg-blue-500/15 text-blue-400 border border-blue-500/20">
                        <span class="material-icons-round text-2xl">language</span>
                    </div>
                    <div class="corporate-action-content">
                        <span class="corporate-action-title">Web Search</span>
                        <span class="corporate-action-desc">Browse internet</span>
                    </div>
                </button>
                <button class="corporate-action-btn group" onclick="insertPrompt('Read and summarize a file')">
                    <div class="corporate-action-icon bg-amber-500/15 text-amber-400 border border-amber-500/20">
                        <span class="material-icons-round text-2xl">description</span>
                    </div>
                    <div class="corporate-action-content">
                        <span class="corporate-action-title">File Analysis</span>
                        <span class="corporate-action-desc">Process documents</span>
                    </div>
                </button>
                <button class="corporate-action-btn group" onclick="insertPrompt('Connect via SSH to my server')">
                    <div class="corporate-action-icon bg-emerald-500/15 text-emerald-400 border border-emerald-500/20">
                        <span class="material-icons-round text-2xl">terminal</span>
                    </div>
                    <div class="corporate-action-content">
                        <span class="corporate-action-title">SSH Access</span>
                        <span class="corporate-action-desc">Remote commands</span>
                    </div>
                </button>
                <button class="corporate-action-btn group" onclick="insertPrompt('What tools do you have available?')">
                    <div class="corporate-action-icon bg-purple-500/15 text-purple-400 border border-purple-500/20">
                        <span class="material-icons-round text-2xl">build</span>
                    </div>
                    <div class="corporate-action-content">
                        <span class="corporate-action-title">Tools</span>
                        <span class="corporate-action-desc">View capabilities</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Input Area - Улучшенный легкий дизайн -->
    <div
        class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-bg-base via-bg-base/98 to-transparent pt-8 pb-8 px-8 md:px-16 lg:px-24 z-20 border-t border-white/10 transition-base">
        <div id="tour-chat-input-area" class="max-w-6xl mx-auto" data-tour="chat-input-model">
            <!-- Task context (при task_id в URL) -->
            <div id="task-context-panel" class="mb-4 hidden rounded-xl border border-primary/30 bg-primary/5 p-4">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="material-icons-round text-lg text-primary">assignment</span>
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Обсуждаемая задача</span>
                            <span id="task-context-status" class="text-xs px-2 py-0.5 rounded-full bg-white/10 text-gray-300"></span>
                        </div>
                        <h3 id="task-context-title" class="font-medium text-white text-sm mb-1"></h3>
                        <p id="task-context-desc" class="text-xs text-gray-400 line-clamp-2"></p>
                    </div>
                    <a id="task-context-link" href="/tasks/" class="text-xs text-primary hover:underline flex items-center gap-1 shrink-0">К задачам <span class="material-icons-round text-sm">open_in_new</span></a>
                </div>
            </div>
            <!-- Options Bar: compact enterprise -->
            <div id="chat-options-bar" class="flex flex-wrap items-center justify-between gap-3 mb-4 px-1">
                <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                    <!-- Provider · Model inline compact -->
                    <div class="flex items-center gap-2 rounded-lg bg-bg-surface/80 border border-white/10 px-2.5 py-1.5">
                        <span class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider shrink-0">Model</span>
                        <select id="provider-select"
                            class="chat-model-select corporate-select bg-transparent border-0 py-1 pr-6 pl-1 text-xs text-gray-100 font-medium focus:outline-none focus:ring-0 cursor-pointer appearance-none"
                            title="Провайдер: Gemini или Grok" aria-label="Провайдер">
                            <option value="gemini" {% if is_gemini_default %}selected{% endif %}>Gemini</option>
                            <option value="grok" {% if is_grok_default %}selected{% endif %}>Grok</option>
                        </select>
                        <span class="text-gray-600">·</span>
                        <select id="model-select"
                            class="chat-model-select corporate-select bg-transparent border-0 py-1 pr-6 pl-1 text-xs text-gray-100 font-medium focus:outline-none focus:ring-0 cursor-pointer appearance-none min-w-[120px]"
                            title="Модель: Pro точнее, Flash быстрее" aria-label="Модель">
                            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
                            <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                        </select>
                    </div>
                    <!-- RAG compact -->
                    <label class="flex items-center gap-2 cursor-pointer group rounded-lg bg-bg-surface/80 border border-white/10 px-2.5 py-1.5 hover:border-white/15 transition-colors" title="{% if rag_available %}Поиск по базе знаний{% else %}RAG недоступен (mini). Для RAG установите полную сборку: pip install -r requirements-full.txt{% endif %}" id="tour-rag-toggle">
                        <input type="checkbox" id="use-rag" {% if rag_available %}checked{% endif %}
                            {% if not rag_available %}disabled{% endif %}
                            class="w-3.5 h-3.5 rounded border-white/20 text-primary focus:ring-2 focus:ring-primary/50 focus:ring-offset-0"
                            aria-label="RAG">
                        <span class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider group-hover:text-gray-400">RAG</span>
                        {% if not rag_available %}<span class="text-[9px] text-amber-400/80" title="Мини-сборка: RAG отключён">(mini)</span>{% endif %}
                    </label>
                    <button type="button" id="btn-clear-chat" onclick="clearChat()"
                        class="corporate-clear-btn flex items-center gap-2 rounded-lg px-2.5 py-1.5 text-[10px] font-semibold text-gray-500 hover:text-gray-300 hover:bg-white/5 uppercase tracking-wider"
                        aria-label="Очистить историю чата" title="Очистить историю">
                        <span class="material-icons-round text-base">delete_sweep</span>
                        <span class="hidden sm:inline">Clear</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" id="btn-shortcuts-help" class="flex items-center gap-2 rounded-lg px-2.5 py-1.5 text-[10px] font-semibold text-gray-500 hover:text-gray-300 hover:bg-white/5 uppercase tracking-wider"
                        onclick="showShortcutsHelp()" aria-label="Горячие клавиши" title="Горячие клавиши (Ctrl+/)">
                        <span class="material-icons-round text-base">keyboard</span>
                        <span class="hidden sm:inline">Shortcuts</span>
                    </button>
                </div>
            </div>

            <!-- File Upload Area (Hidden) -->
            <input type="file" id="file-input" multiple accept=".txt,.md,.pdf,.docx,.doc,.jpg,.jpeg,.png,.gif,.bmp,.webp" style="display: none;">
            
            <!-- Attached Files Display -->
            <div id="attached-files" class="mb-4 space-y-2.5 hidden"></div>
            
            <!-- Input Box - Современный и легкий -->
            <div id="input-container"
                class="corporate-input-container glass-md rounded-xl p-3 transition-base focus-within:border-primary/50 focus-within:shadow-primary focus-within:shadow-primary-lg"
                ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="flex items-end gap-3">
                    <textarea id="chat-input" rows="1" placeholder="Type your message or drag files here to attach..."
                        class="flex-1 bg-transparent text-gray-100 text-sm placeholder-gray-500 px-5 py-4 focus:outline-none resize-none overflow-hidden min-h-[56px] max-h-[200px] leading-relaxed font-normal"
                        oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 200) + 'px'"
                        title="Сообщение: Ctrl+Enter — отправить, Shift+Enter — новая строка" aria-label="Ввод сообщения"></textarea>

                    <div class="flex items-center gap-2 pb-2.5 pr-2.5">
                        <button id="attach-btn" type="button" class="corporate-icon-btn p-3 rounded-xl" title="Attach File" aria-label="Attach file" onclick="document.getElementById('file-input').click()">
                            <span class="material-icons-round text-xl" aria-hidden="true">attach_file</span>
                        </button>
                        <button id="send-btn" type="button"
                            class="corporate-send-btn w-12 h-12 bg-primary hover:bg-primary-hover text-white rounded-xl shadow-xl shadow-primary/30 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                            aria-label="Send message">
                            <span class="material-icons-round text-xl" id="send-icon" aria-hidden="true">send</span>
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mt-4 font-medium">
                <kbd class="px-2 py-1 bg-bg-surface border border-white/15 rounded-md text-xs font-mono">Ctrl+Enter</kbd> — отправить • <kbd class="px-2 py-1 bg-bg-surface border border-white/15 rounded-md text-xs font-mono">Shift+Enter</kbd> — новая строка • Перетащите файлы для загрузки
            </p>
        </div>
    </div>

</div>

<!-- Shortcuts help overlay -->
<div id="shortcuts-help-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden" aria-hidden="true" aria-modal="true">
    <div id="shortcuts-help-dialog" class="bg-bg-surface border border-white/15 rounded-xl shadow-2xl max-w-md mx-4 p-6 relative" role="dialog" aria-label="Справка по горячим клавишам" tabindex="-1">
        <button type="button" id="shortcuts-help-close" onclick="hideShortcutsHelp()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors p-1 rounded focus:outline-none focus:ring-2 focus:ring-primary/50" aria-label="Закрыть (Escape)">
            <span class="material-icons-round">close</span>
        </button>
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-icons-round text-primary">keyboard</span>
            Горячие клавиши
        </h3>
        <ul class="space-y-3 text-sm text-gray-300">
            <li class="flex items-center justify-between gap-4">
                <span>Отправить сообщение</span>
                <kbd class="px-2 py-1 bg-bg-base border border-white/15 rounded text-xs font-mono">Ctrl+Enter</kbd>
            </li>
            <li class="flex items-center justify-between gap-4">
                <span>Новая строка</span>
                <kbd class="px-2 py-1 bg-bg-base border border-white/15 rounded text-xs font-mono">Shift+Enter</kbd>
            </li>
            <li class="flex items-center justify-between gap-4">
                <span>Очистить чат</span>
                <kbd class="px-2 py-1 bg-bg-base border border-white/15 rounded text-xs font-mono">Ctrl+L</kbd>
            </li>
            <li class="flex items-center justify-between gap-4">
                <span>Остановить ответ</span>
                <span class="text-gray-500 text-xs">кнопка Stop при ответе</span>
            </li>
            <li class="flex items-center justify-between gap-4">
                <span>Эта справка</span>
                <kbd class="px-2 py-1 bg-bg-base border border-white/15 rounded text-xs font-mono">Ctrl+/</kbd>
            </li>
        </ul>
        <p class="text-xs text-gray-500 mt-4">На Mac используйте <kbd class="font-mono">Cmd</kbd> вместо <kbd class="font-mono">Ctrl</kbd>. Фокус по Tab: модель → RAG → Clear → поле ввода → вложение → отправить → Shortcuts.</p>
    </div>
</div>

<!-- Message Templates -->
<template id="user-msg-template">
    <div class="flex justify-end animate-fade-in-up corporate-message-wrapper" data-role="user-msg">
        <div class="max-w-[85%] md:max-w-[75%] lg:max-w-[70%] flex gap-5 flex-row-reverse group/msg">
            <div
                class="w-11 h-11 rounded-xl bg-gradient-to-br from-primary to-primary-hover flex items-center justify-center flex-shrink-0 text-sm font-semibold text-white shadow-lg border border-primary/30">
                <span class="material-icons-round text-xl">person</span>
            </div>
            <div class="flex flex-col items-end gap-2.5 flex-1 min-w-0">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-gray-200 uppercase tracking-wider">You</span>
                    <span class="message-timestamp text-xs text-gray-500 font-mono"></span>
                </div>
                <div class="corporate-message-user px-6 py-4.5 text-sm leading-relaxed user-content shadow-lg">
                </div>
                <div class="msg-actions flex items-center gap-1.5 mt-1.5 opacity-70 group-hover/msg:opacity-100 transition-opacity" role="group" aria-label="Действия с сообщением"></div>
            </div>
        </div>
    </div>
</template>

<template id="ai-msg-template">
    <div class="flex justify-start animate-fade-in-up corporate-message-wrapper" data-role="ai-msg">
        <div class="max-w-[85%] md:max-w-[75%] lg:max-w-[70%] flex gap-5 group/msg">
            <div
                class="w-11 h-11 rounded-xl bg-bg-surface border border-white/15 flex items-center justify-center flex-shrink-0 shadow-lg">
                <span class="material-icons-round text-xl text-primary">support_agent</span>
            </div>
            <div class="flex flex-col gap-2.5 flex-1 min-w-0">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-gray-200 uppercase tracking-wider">AI Assistant</span>
                    <span class="message-timestamp text-xs text-gray-500 font-mono"></span>
                </div>
                <div class="corporate-message-ai px-6 py-4.5 text-sm leading-relaxed prose prose-invert max-w-none ai-content shadow-lg">
                </div>
                <div class="msg-actions flex items-center gap-1.5 mt-1.5 opacity-70 group-hover/msg:opacity-100 transition-opacity" role="group" aria-label="Действия с сообщением"></div>
            </div>
        </div>
    </div>
</template>

<template id="thinking-template">
    <div class="flex justify-start animate-fade-in thinking-wrapper corporate-message-wrapper">
        <div class="max-w-[85%] md:max-w-[75%] lg:max-w-[70%] flex gap-5 items-center">
            <div
                class="w-11 h-11 rounded-xl bg-bg-surface border border-white/15 flex items-center justify-center flex-shrink-0 shadow-lg">
                <span class="material-icons-round text-xl text-primary animate-pulse">hourglass_empty</span>
            </div>
            <div class="flex flex-col gap-2.5 flex-1">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-gray-200 uppercase tracking-wider">AI Assistant</span>
                    <span class="text-xs text-gray-500 font-medium">Processing...</span>
                </div>
                <div class="corporate-message-ai px-6 py-4.5">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
            <button type="button" class="btn-stop-stream flex items-center gap-1.5 px-3 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 text-xs font-medium transition-colors"
                aria-label="Остановить ответ" title="Остановить стриминг">
                <span class="material-icons-round text-base">stop</span>
                <span>Stop</span>
            </button>
        </div>
    </div>
</template>

{# Chat/orporate/prose/msg styles — core_ui/static/css/style.css #}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Elements
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const sendIcon = document.getElementById('send-icon');
    const welcomeMsg = document.getElementById('welcome-message');
    const providerSelect = document.getElementById('provider-select');
    const modelSelect = document.getElementById('model-select');
    const useRagCheckbox = document.getElementById('use-rag');

    // Models per provider (for model-select)
    const MODEL_OPTIONS = {
        gemini: [
            { value: 'gemini-2.0-flash-exp', label: 'gemini-2.0-flash-exp' },
            { value: 'gemini-1.5-pro', label: 'gemini-1.5-pro' },
            { value: 'gemini-1.5-flash', label: 'gemini-1.5-flash' }
        ],
        grok: [
            { value: 'grok-beta', label: 'grok-beta' },
            { value: 'grok-2', label: 'grok-2' }
        ]
    };

    function updateModelOptions() {
        const provider = providerSelect.value;
        const options = MODEL_OPTIONS[provider] || MODEL_OPTIONS.gemini;
        const currentModel = modelSelect.value;
        modelSelect.innerHTML = '';
        options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt.value;
            o.textContent = opt.label;
            if (opt.value === currentModel) o.selected = true;
            modelSelect.appendChild(o);
        });
        if (!options.find(o => o.value === currentModel)) {
            modelSelect.selectedIndex = 0;
        }
    }
    providerSelect.addEventListener('change', function() { updateModelOptions(); syncHeaderModel(); });
    modelSelect.addEventListener('change', syncHeaderModel);
    updateModelOptions();

    function syncHeaderModel() {
        var el = document.getElementById('header-current-model');
        if (el && modelSelect && modelSelect.options.length) {
            var opt = modelSelect.options[modelSelect.selectedIndex];
            el.textContent = opt ? opt.text : modelSelect.value;
        }
    }
    syncHeaderModel();

    // Configure marked
    marked.setOptions({
        highlight: function (code, lang) {
            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
        },
        breaks: true,
        gfm: true
    });

    // Event Listeners
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendBtn.addEventListener('click', sendMessage);

    // Quick action helper
    function insertPrompt(text) {
        chatInput.value = text;
        chatInput.focus();
        chatInput.style.height = '';
        chatInput.style.height = chatInput.scrollHeight + 'px';
    }

    // Clear chat
    function clearChat() {
        const messages = chatContainer.querySelectorAll('.flex.justify-start, .flex.justify-end');
        messages.forEach(msg => msg.remove());

        if (welcomeMsg) {
            welcomeMsg.style.display = 'flex';
        }

        // Also clear server history
        fetch('/api/clear-history/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
    }

    // Shortcuts help: focus trap and a11y
    var shortcutsHelpTrapRef = null;
    function showShortcutsHelp() {
        var overlay = document.getElementById('shortcuts-help-overlay');
        var dialog = document.getElementById('shortcuts-help-dialog');
        var closeBtn = document.getElementById('shortcuts-help-close');
        if (overlay) {
            overlay.classList.remove('hidden');
            overlay.setAttribute('aria-hidden', 'false');
            if (closeBtn) closeBtn.focus();
            shortcutsHelpTrapRef = function(e) {
                if (e.key !== 'Tab' || !dialog) return;
                var focusables = dialog.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                var first = focusables[0], last = focusables[focusables.length - 1];
                if (e.shiftKey) {
                    if (document.activeElement === first) { e.preventDefault(); last && last.focus(); }
                } else {
                    if (document.activeElement === last) { e.preventDefault(); first && first.focus(); }
                }
            };
            overlay.addEventListener('keydown', shortcutsHelpTrapRef);
        }
    }

    function hideShortcutsHelp() {
        var overlay = document.getElementById('shortcuts-help-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
            overlay.setAttribute('aria-hidden', 'true');
            if (shortcutsHelpTrapRef) {
                overlay.removeEventListener('keydown', shortcutsHelpTrapRef);
                shortcutsHelpTrapRef = null;
            }
            var btn = document.getElementById('btn-shortcuts-help');
            if (btn) btn.focus();
        }
    }

    // Global keydown: Ctrl/Cmd+Enter, Ctrl/Cmd+/, Ctrl/Cmd+L
    document.addEventListener('keydown', function(e) {
        const mod = e.ctrlKey || e.metaKey;
        if (!mod) return;

        if (e.key === 'Enter') {
            if (document.activeElement !== chatInput) {
                e.preventDefault();
                sendMessage();
            }
            return;
        }
        if (e.key === '/') {
            e.preventDefault();
            showShortcutsHelp();
            return;
        }
        if (e.key === 'l' || e.key === 'L') {
            e.preventDefault();
            if (confirm('Очистить историю чата?')) {
                clearChat();
            }
            return;
        }
    });

    // Close shortcuts overlay on Escape or click outside
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideShortcutsHelp();
        }
    });
    (function() {
        const overlay = document.getElementById('shortcuts-help-overlay');
        if (overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) hideShortcutsHelp();
            });
        }
    })();

    // AbortController for stop streaming
    var currentChatAbortController = null;

    // Main send function
    async function sendMessage(overriddenText) {
        const text = (overriddenText != null ? String(overriddenText).trim() : chatInput.value.trim());
        if (!text) return;

        // Reset UI
        if (overriddenText == null) {
            chatInput.value = '';
            chatInput.style.height = 'auto';
        }
        sendBtn.classList.add('btn-loading');
        sendBtn.disabled = true;

        if (welcomeMsg) {
            welcomeMsg.style.display = 'none';
        }

        // Add user message (only if not retry — retry doesn't add again)
        if (overriddenText == null) {
            var userContent = appendMessage(text, 'user');
            var userWrapper = userContent && userContent.closest('.corporate-message-wrapper');
            if (userWrapper) attachMessageActions(userWrapper, 'user', userContent);
        }

        // Add thinking indicator
        const thinkingEl = appendThinking();
        if (currentChatAbortController) currentChatAbortController.abort();
        currentChatAbortController = new AbortController();
        var stopBtn = thinkingEl.querySelector && thinkingEl.querySelector('.btn-stop-stream');
        if (stopBtn) {
            stopBtn.onclick = function() { currentChatAbortController && currentChatAbortController.abort(); };
        }

        try {
            const response = await fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: text,
                    model: providerSelect.value,
                    specific_model: modelSelect.value,
                    use_rag: useRagCheckbox.checked
                }),
                signal: currentChatAbortController.signal
            });

            if (!response.ok) {
                if (response.status === 429 && typeof showToast === 'function') {
                    showToast('Превышен лимит запросов. Подождите и попробуйте снова.', 'error', 6000);
                }
                throw new Error('HTTP ' + response.status);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedText = '';
            let aiContentDiv = null;

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                accumulatedText += chunk;

                // Remove thinking indicator and create AI message on first chunk
                if (!aiContentDiv) {
                    thinkingEl.remove();
                    aiContentDiv = appendMessage('', 'ai');
                }

                // Render markdown
                aiContentDiv.innerHTML = marked.parse(accumulatedText);

                // Apply syntax highlighting to code blocks
                if (typeof hljs !== 'undefined') {
                    aiContentDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }

                // Add copy buttons to code blocks
                attachCopyButtons(aiContentDiv);

                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // If no response received
            if (!aiContentDiv) {
                thinkingEl.remove();
                aiContentDiv = appendMessage('No response received.', 'ai');
            }
            var aiWrapper = aiContentDiv && aiContentDiv.closest('.corporate-message-wrapper');
            if (aiWrapper) attachMessageActions(aiWrapper, 'ai', aiContentDiv);

        } catch (error) {
            if (error.name === 'AbortError') {
                thinkingEl.remove();
                if (typeof showToast === 'function') showToast('Ответ остановлен', 'info', 2000);
                return;
            }
            console.error('Chat error:', error);
            thinkingEl.remove();
            const errorContent = appendMessage('', 'ai');
            errorContent.innerHTML = `
                <div class="flex items-center gap-2 text-red-400">
                    <span class="material-icons-round text-lg">error_outline</span>
                    <span>Error: ${error.message}</span>
                </div>
            `;
            var errWrapper = errorContent.closest('.corporate-message-wrapper');
            if (errWrapper) attachMessageActions(errWrapper, 'ai', errorContent);
            if (typeof showToast === 'function' && error.message.indexOf('429') < 0) showToast('Ошибка: ' + error.message, 'error', 4000);
        } finally {
            currentChatAbortController = null;
            sendBtn.classList.remove('btn-loading');
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    // Format timestamp
    function formatTimestamp(date = new Date()) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // Append message to chat
    function appendMessage(text, type) {
        const template = document.getElementById(type === 'user' ? 'user-msg-template' : 'ai-msg-template');
        const clone = template.content.cloneNode(true);

        // Add timestamp
        const timestampEl = clone.querySelector('.message-timestamp');
        if (timestampEl) {
            timestampEl.textContent = formatTimestamp();
        }

        let contentDiv;
        if (type === 'user') {
            contentDiv = clone.querySelector('.user-content');
            contentDiv.textContent = text;
        } else {
            contentDiv = clone.querySelector('.ai-content');
            if (text) {
                contentDiv.innerHTML = marked.parse(text);
            }
        }

        chatContainer.appendChild(clone);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const messages = chatContainer.querySelectorAll(type === 'user' ? '.user-content' : '.ai-content');
        return messages[messages.length - 1];
    }

    // Add thinking indicator
    function appendThinking() {
        const template = document.getElementById('thinking-template');
        const clone = template.content.cloneNode(true);
        chatContainer.appendChild(clone);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const wrappers = chatContainer.querySelectorAll('.thinking-wrapper');
        return wrappers[wrappers.length - 1];
    }

    // Message actions: copy whole, copy code, retry (ai)
    function attachMessageActions(wrapper, type, contentEl) {
        var actionsDiv = wrapper && wrapper.querySelector('.msg-actions');
        if (!actionsDiv || !contentEl) return;
        actionsDiv.innerHTML = '';

        function addBtn(icon, label, onClick) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'msg-action-btn';
            btn.setAttribute('aria-label', label);
            btn.innerHTML = '<span class="material-icons-round" aria-hidden="true">' + icon + '</span> ' + label;
            btn.addEventListener('click', onClick);
            actionsDiv.appendChild(btn);
        }

        function copyToClip(s) {
            navigator.clipboard.writeText(s || '').then(function() {
                if (typeof showToast === 'function') showToast('Скопировано', 'success', 2000);
            }).catch(function() {
                if (typeof showToast === 'function') showToast('Ошибка копирования', 'error', 2000);
            });
        }

        addBtn('content_copy', 'Copy', function() { copyToClip(contentEl.textContent); });

        if (type === 'ai') {
            var codes = contentEl.querySelectorAll('pre code');
            if (codes.length) {
                var allCode = Array.prototype.map.call(codes, function(c) { return c.textContent || ''; }).join('\n\n');
                if (allCode) addBtn('code', 'Copy code', function() { copyToClip(allCode); });
            }
            var aiWrappers = chatContainer.querySelectorAll('[data-role="ai-msg"]');
            var isLast = wrapper.getAttribute('data-role') === 'ai-msg' && aiWrappers.length && aiWrappers[aiWrappers.length - 1] === wrapper;
            if (isLast) {
                addBtn('replay', 'Retry', function() {
                    var prev = wrapper.previousElementSibling;
                    while (prev && prev.getAttribute('data-role') !== 'user-msg') prev = prev.previousElementSibling;
                    var prevText = prev && prev.querySelector('.user-content') && prev.querySelector('.user-content').textContent;
                    if (prevText) {
                        wrapper.remove();
                        sendMessage(prevText);
                    }
                });
            }
        }
    }

    // Add copy buttons to code blocks (pre>code or .code-block)
    function attachCopyButtons(container) {
        if (!container) return;
        container.querySelectorAll('pre').forEach(function (pre) {
            const code = pre.querySelector('code');
            if (!code) return;
            if (pre.querySelector('.copy-btn')) return;
            pre.classList.add('code-block');
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'copy-btn';
            btn.title = 'Копировать';
            btn.setAttribute('aria-label', 'Copy code block');
            btn.innerHTML = '<span class="material-icons-round copy-icon" aria-hidden="true">content_copy</span>';
            btn.addEventListener('click', async function () {
                const text = code.textContent || '';
                try {
                    await navigator.clipboard.writeText(text);
                    if (typeof showToast === 'function') showToast('Скопировано', 'success', 2000);
                    var icon = btn.querySelector('.copy-icon');
                    if (icon) {
                        icon.textContent = 'check';
                        setTimeout(function () { icon.textContent = 'content_copy'; }, 2000);
                    }
                } catch (e) {
                    if (typeof showToast === 'function') showToast('Ошибка копирования', 'error', 2000);
                }
            });
            pre.appendChild(btn);
        });
    }

    // CSRF from common.js — window.getCookie('csrftoken')
    var getCookie = window.getCookie || function() { return null; };

    // File upload handling
    const fileInput = document.getElementById('file-input');
    const attachedFilesDiv = document.getElementById('attached-files');
    const inputContainer = document.getElementById('input-container');
    let attachedFiles = [];

    fileInput.addEventListener('change', (e) => {
        handleFiles(Array.from(e.target.files));
    });

    function handleFiles(files) {
        files.forEach(file => {
            if (!attachedFiles.find(f => f.name === file.name && f.size === file.size)) {
                attachedFiles.push(file);
                uploadFile(file);
            }
        });
        fileInput.value = ''; // Reset input
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.remove('border-primary', 'border-2', 'bg-primary/5');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.add('border-primary', 'border-2', 'bg-primary/5');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.remove('border-primary', 'border-2', 'bg-primary/5');
    }

    async function uploadFile(file) {
        // Show file in attached files list
        const fileId = `file-${Date.now()}-${Math.random()}`;
        const fileItem = document.createElement('div');
        fileItem.id = fileId;
        fileItem.className = 'flex items-center gap-3 bg-bg-surface border border-white/10 rounded-lg px-4 py-3 text-sm';
        fileItem.innerHTML = `
            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                <span class="material-icons-round text-lg text-primary">description</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-gray-200 font-medium truncate">${file.name}</div>
                <div class="text-xs text-gray-500 mt-0.5">${formatFileSize(file.size)}</div>
            </div>
            <span class="material-icons-round text-base text-gray-500 animate-spin">hourglass_empty</span>
        `;
        attachedFilesDiv.appendChild(fileItem);
        attachedFilesDiv.classList.remove('hidden');

        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/chat/upload/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                fileItem.innerHTML = `
                    <div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                        <span class="material-icons-round text-lg text-emerald-400">check_circle</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-gray-200 font-medium truncate">${file.name}</div>
                        <div class="text-xs text-gray-500 mt-0.5">${formatFileSize(file.size)} • Uploaded</div>
                    </div>
                    <button type="button" onclick="removeFile('${fileId}', '${file.name}')" class="corporate-icon-btn p-2 rounded-lg text-gray-500 hover:text-red-400 transition-colors" aria-label="Remove file ${String(file.name).replace(/"/g, '&quot;')}">
                        <span class="material-icons-round text-base" aria-hidden="true">close</span>
                    </button>
                `;
                
                // Show success notification
                if (typeof showToast === 'function') showToast(`Файл "${file.name}" загружен и добавлен в базу знаний`, 'success');
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        } catch (error) {
            console.error('Upload error:', error);
            fileItem.innerHTML = `
                <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center">
                    <span class="material-icons-round text-lg text-red-400">error</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-gray-200 font-medium truncate">${file.name}</div>
                    <div class="text-xs text-red-400 mt-0.5">Upload failed</div>
                </div>
                <button type="button" onclick="removeFile('${fileId}', '${file.name}')" class="corporate-icon-btn p-2 rounded-lg text-gray-500 hover:text-red-400 transition-colors" aria-label="Remove file ${String(file.name).replace(/"/g, '&quot;')}">
                    <span class="material-icons-round text-base" aria-hidden="true">close</span>
                </button>
            `;
            if (typeof showToast === 'function') showToast(`Ошибка загрузки "${file.name}": ${error.message}`, 'error');
        }
    }

    function removeFile(fileId, fileName) {
        const fileItem = document.getElementById(fileId);
        if (fileItem) {
            fileItem.remove();
        }
        attachedFiles = attachedFiles.filter(f => f.name !== fileName);
        
        if (attachedFiles.length === 0) {
            attachedFilesDiv.classList.add('hidden');
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Focus input on load
    chatInput.focus();

    // Task context from URL (task_id): загрузить задачу и показать над полем ввода
    function getTaskIdFromUrl() {
        try {
            return new URL(window.location.href).searchParams.get('task_id') || null;
        } catch (e) {
            return null;
        }
    }

    function showTaskContext(task) {
        var panel = document.getElementById('task-context-panel');
        var titleEl = document.getElementById('task-context-title');
        var descEl = document.getElementById('task-context-desc');
        var statusEl = document.getElementById('task-context-status');
        var linkEl = document.getElementById('task-context-link');
        if (!panel || !titleEl || !descEl) return;
        titleEl.textContent = task.title || '';
        descEl.textContent = (task.description || '').trim() || '—';
        statusEl.textContent = task.status === 'TODO' ? 'To Do' : (task.status === 'IN_PROGRESS' ? 'In Progress' : (task.status === 'DONE' ? 'Done' : (task.status || '')));
        if (linkEl) linkEl.href = '/tasks/';
        panel.classList.remove('hidden');
    }

    function loadTaskContextIfPresent() {
        var taskId = getTaskIdFromUrl();
        if (!taskId) return;
        fetch('/tasks/' + taskId + '/', { credentials: 'same-origin', headers: { 'Accept': 'application/json' } })
            .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('Task not found')); })
            .then(showTaskContext)
            .catch(function() {});
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTaskContextIfPresent);
    } else {
        loadTaskContextIfPresent();
    }

    // Check API keys on load (non-blocking, user can close toast)
    function runSettingsCheck() {
        fetch('/api/settings/check/')
            .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
            .then(function(data) {
                if (data && data.configured === false && typeof showToast === 'function') {
                    showToast('Не настроены API ключи. Перейдите в Настройки', 'warning', 10000, '/settings/');
                }
            })
            .catch(function() {});
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', runSettingsCheck);
    } else {
        runSettingsCheck();
    }

    // Check for initial prompt
    {% if initial_prompt %}
    setTimeout(() => {
        chatInput.value = `{{ initial_prompt|escapejs }}`;
        chatInput.style.height = '';
        chatInput.style.height = chatInput.scrollHeight + 'px';
        sendMessage();
    }, 500);
    {% endif %}
</script>
{% endblock %}