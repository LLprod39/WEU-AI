{% extends 'base.html' %}

{% block body_extra_class %}page-chat{% endblock %}

{% block header_title %}Chat{% endblock %}
{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="flex items-center gap-2 text-sm min-w-0">
    <ol class="flex items-center gap-2 list-none flex-wrap" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2">
            <a href="{% url 'index' %}" class="text-gray-500 hover:text-white transition-colors" itemprop="item"><span itemprop="name">Home</span></a>
            <meta itemprop="position" content="1">
            <span class="text-gray-600" aria-hidden="true">/</span>
        </li>
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" class="flex items-center gap-2" aria-current="page">
            <span class="font-medium text-white" itemprop="name">Chat</span>
            <meta itemprop="position" content="2">
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="chat-shell">
    <!-- Кнопка открыть историю (когда панель скрыта) -->
    <button type="button" id="chat-sidebar-expand-tab" class="chat-rail-expand hidden" aria-label="Открыть панель чатов" title="Открыть панель чатов">
        <span class="material-icons-round">chevron_right</span>
    </button>

    <!-- Sidebar: история чатов -->
    <aside id="chat-history-sidebar" class="chat-rail" aria-label="История чатов">
        <div class="chat-rail-header">
            <span class="chat-rail-title">Чаты</span>
            <div class="chat-rail-actions">
                <button type="button" id="btn-new-chat" class="chat-rail-btn chat-rail-btn--primary" title="Новый чат" aria-label="Новый чат">
                    <span class="material-icons-round">add</span>
                    <span class="hidden sm:inline">Новый</span>
                </button>
                <button type="button" id="btn-toggle-sidebar" class="chat-rail-btn" aria-label="Свернуть панель чатов" title="Свернуть панель">
                    <span class="material-icons-round">chevron_left</span>
                </button>
            </div>
        </div>
        <div class="chat-rail-search">
            <span class="material-icons-round" aria-hidden="true">search</span>
            <input id="chat-search" type="text" placeholder="Поиск по чатам" aria-label="Поиск по чатам">
        </div>
        <div id="chat-history-list" class="chat-rail-list" role="list"></div>
        <div id="chat-history-empty" class="chat-rail-empty hidden">
            <span class="material-icons-round">chat_bubble_outline</span>
            <p>История пуста</p>
            <span>Создайте чат, чтобы он появился в списке</span>
        </div>
    </aside>

    <!-- Main: область сообщений + ввод -->
    <section class="chat-stage">
        <div id="chat-container" class="chat-stream">
            <!-- Welcome -->
            <div id="welcome-message" class="chat-welcome">
                <div class="chat-welcome-icon">
                    <span class="material-icons-round">support_agent</span>
                </div>
                <h2>Чат ассистента</h2>
                <p>Сформулируйте задачу, добавьте контекст или перетащите файлы — ассистент поможет с анализом и действиями.</p>
                <div class="chat-welcome-actions">
                    <button type="button" class="chat-quick-card" onclick="insertPrompt('Дай краткую сводку по активным задачам')">
                        <span class="material-icons-round">assignment</span>
                        <span>Сводка задач</span>
                    </button>
                    <button type="button" class="chat-quick-card" onclick="insertPrompt('Проанализируй загруженный файл и выдели риски')">
                        <span class="material-icons-round">description</span>
                        <span>Анализ файла</span>
                    </button>
                    <button type="button" class="chat-quick-card" onclick="insertPrompt('Проверь статус инфраструктуры и дай рекомендации')">
                        <span class="material-icons-round">dns</span>
                        <span>Статус серверов</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-composer">
            <div id="tour-chat-input-area" class="chat-composer-inner">
                <div id="task-context-panel" class="chat-task-context hidden">
                    <div class="chat-task-body">
                        <div class="chat-task-header">
                            <span class="material-icons-round" aria-hidden="true">assignment</span>
                            <span class="chat-task-label">Обсуждаемая задача</span>
                            <span id="task-context-status" class="chat-task-status" title="Статус задачи"></span>
                        </div>
                        <h3 id="task-context-title" class="chat-task-title"></h3>
                        <p id="task-context-desc" class="chat-task-desc"></p>
                    </div>
                    <a id="task-context-link" href="/tasks/" class="chat-task-link">К задачам <span class="material-icons-round">open_in_new</span></a>
                </div>
                <div id="chat-options-bar" class="chat-toolbar">
                    <div class="chat-toolbar-left">
                        <div id="chat-model-row" class="chat-select-group">
                            <span class="chat-select-label">Model</span>
                            <select id="provider-select" class="chat-model-select" title="Провайдер" aria-label="Провайдер">
                                <option value="auto" selected>Smart Auto</option>
                                <option value="cursor">Cursor CLI</option>
                                <option value="gemini">Gemini</option>
                                <option value="grok">Grok</option>
                            </select>
                            <span id="model-sep" class="chat-select-sep">·</span>
                            <select id="model-select" class="chat-model-select" title="Модель" aria-label="Модель">
                                <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
                                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                                <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                            </select>
                        </div>
                        <label class="chat-rag-toggle" title="{% if rag_available %}Поиск по базе знаний{% else %}RAG недоступен{% endif %}" id="tour-rag-toggle">
                            <input type="checkbox" id="use-rag" {% if rag_available %}checked{% endif %} {% if not rag_available %}disabled{% endif %} aria-label="RAG">
                            <span>RAG</span>
                            {% if not rag_available %}<span class="chat-rag-note" title="Мини-сборка: RAG отключён">mini</span>{% endif %}
                        </label>
                        <div class="chat-select-group">
                            <span class="chat-select-label">Mode</span>
                            <select id="orchestrator-mode-select" class="chat-model-select" title="Orchestrator Mode" aria-label="Mode">
                                <option value="chat" selected>Chat (Fast)</option>
                                <option value="react">ReAct (Precise)</option>
                            </select>
                        </div>
                        <button type="button" id="btn-clear-chat" onclick="clearChat()" class="chat-ghost-btn" aria-label="Очистить историю чата" title="Очистить историю">
                            <span class="material-icons-round">delete_sweep</span>
                            <span>Clear history</span>
                        </button>
                    </div>
                    <div class="chat-toolbar-right">
                        <button type="button" id="btn-chat-info" class="chat-ghost-btn" aria-label="Инструкции чата" title="Инструкции чата">
                            <span class="material-icons-round">info</span>
                            <span>Инструкции</span>
                        </button>
                        <button type="button" id="btn-shortcuts-help" class="chat-ghost-btn" onclick="showShortcutsHelp()" aria-label="Горячие клавиши" title="Горячие клавиши (Ctrl+/)">
                            <span class="material-icons-round">keyboard</span>
                            <span>Клавиши</span>
                        </button>
                    </div>
                </div>
                <div id="chat-instructions" class="chat-instructions hidden" aria-live="polite">
                    <p class="chat-instructions-title">Что умеет этот чат</p>
                    <ul>
                        <li>RAG — при включенной галочке использует базу знаний для ответов.</li>
                        <li>Задачи — доступ к списку и карточкам задач (описание, статус, приоритет, сроки, исполнитель).</li>
                        <li>Серверы — доступ к списку серверов и безопасным командам через инструменты (опасные — только после подтверждения).</li>
                        <li>Файлы — можно перетаскивать документы для анализа.</li>
                        <li>Данные ограничены вашим аккаунтом.</li>
                    </ul>
                </div>
                <input type="file" id="file-input" multiple accept=".txt,.md,.pdf,.docx,.doc,.jpg,.jpeg,.png,.gif,.bmp,.webp" style="display: none;">
                <div id="attached-files" class="chat-attachments hidden"></div>
                <div id="input-container" class="chat-input-card" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <textarea id="chat-input" rows="1" placeholder="Опишите задачу, перетащите файлы или попросите краткую сводку..." oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 200) + 'px'" title="Сообщение: Enter — отправить, Shift+Enter — новая строка" aria-label="Ввод сообщения"></textarea>
                    <div class="chat-input-actions">
                        <button id="attach-btn" type="button" class="chat-icon-btn" title="Attach File" aria-label="Attach file" onclick="document.getElementById('file-input').click()">
                            <span class="material-icons-round" aria-hidden="true">attach_file</span>
                        </button>
                        <button id="send-btn" type="button" class="chat-send-btn" aria-label="Send message">
                            <span class="material-icons-round" id="send-icon" aria-hidden="true">send</span>
                        </button>
                    </div>
                </div>
                <p class="chat-input-hint">
                    <kbd>Enter</kbd> — отправить • <kbd>Shift+Enter</kbd> — новая строка • Перетащите файлы для загрузки
                </p>
            </div>
        </div>
    </section>
</div>

<!-- Shortcuts help overlay -->
<div id="shortcuts-help-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden" aria-hidden="true" aria-modal="true">
    <div id="shortcuts-help-dialog" class="chat-shortcuts-dialog" role="dialog" aria-label="Справка по горячим клавишам" tabindex="-1">
        <button type="button" id="shortcuts-help-close" onclick="hideShortcutsHelp()" class="chat-shortcuts-close" aria-label="Закрыть (Escape)">
            <span class="material-icons-round">close</span>
        </button>
        <h3 class="chat-shortcuts-title">
            <span class="material-icons-round">keyboard</span>
            Горячие клавиши
        </h3>
        <ul class="chat-shortcuts-list">
            <li><span>Отправить сообщение</span><kbd>Enter</kbd></li>
            <li><span>Новая строка</span><kbd>Shift+Enter</kbd></li>
            <li><span>Очистить чат</span><kbd>Ctrl+L</kbd></li>
            <li><span>Остановить ответ</span><span class="chat-shortcuts-muted">кнопка Stop при ответе</span></li>
            <li><span>Эта справка</span><kbd>Ctrl+/</kbd></li>
        </ul>
        <p class="chat-shortcuts-footnote">На Mac используйте <kbd>Cmd</kbd> вместо <kbd>Ctrl</kbd>. Фокус по Tab: модель → RAG → Clear → поле ввода → вложение → отправить → Shortcuts.</p>
    </div>
</div>

<!-- Task Modal Window -->
<div id="task-modal" class="task-modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
    <div class="task-modal-backdrop" onclick="closeTaskModal()"></div>
    <div class="task-modal-panel">
        <div class="task-modal-header">
            <div class="task-modal-header-top">
                <h2 id="task-modal-title" class="task-modal-title"></h2>
                <button type="button" class="task-modal-close" onclick="closeTaskModal()" aria-label="Close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="task-modal-meta">
                <span class="task-badge task-badge-status" id="task-modal-status"></span>
                <span class="task-badge task-badge-priority" id="task-modal-priority"></span>
                <span class="task-meta-item" id="task-modal-assignee"></span>
            </div>
        </div>

        <div class="task-modal-body">
            <div class="task-modal-section">
                <h3 class="task-modal-section-title">Description</h3>
                <p id="task-modal-description" class="task-modal-description"></p>
            </div>

            <div class="task-modal-section task-modal-grid">
                <div>
                    <h3 class="task-modal-section-title">Due Date</h3>
                    <p id="task-modal-due-date" class="task-modal-info">—</p>
                </div>
                <div>
                    <h3 class="task-modal-section-title">Server</h3>
                    <p id="task-modal-server" class="task-modal-info">—</p>
                </div>
            </div>

            <div class="task-modal-section">
                <h3 class="task-modal-section-title">Timeline</h3>
                <div class="task-timeline">
                    <div class="task-timeline-item">
                        <span class="task-timeline-label">Created:</span>
                        <span id="task-modal-created" class="task-timeline-value"></span>
                    </div>
                    <div class="task-timeline-item">
                        <span class="task-timeline-label">Updated:</span>
                        <span id="task-modal-updated" class="task-timeline-value"></span>
                    </div>
                    <div class="task-timeline-item">
                        <span class="task-timeline-label">Completed:</span>
                        <span id="task-modal-completed" class="task-timeline-value">—</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="task-modal-actions">
            <button type="button" class="task-action-btn task-action-primary" onclick="discussTask()">
                <span class="material-icons-round">chat</span>
                Discuss in Chat
            </button>
            <button type="button" class="task-action-btn task-action-secondary" onclick="takeTaskInProgress()">
                <span class="material-icons-round">play_arrow</span>
                Start Work
            </button>
            <button type="button" class="task-action-btn task-action-secondary" onclick="openTaskPage()">
                <span class="material-icons-round">open_in_new</span>
                Open Task Page
            </button>
        </div>
    </div>
</div>

<!-- Message Templates -->
<template id="user-msg-template">
    <div class="chat-msg chat-msg-user corporate-message-wrapper" data-role="user-msg">
        <div class="chat-msg-shell">
            <div class="chat-avatar chat-avatar-user">
                <span class="material-icons-round">person</span>
            </div>
            <div class="chat-msg-body">
                <div class="chat-msg-meta">
                    <span class="chat-msg-author">You</span>
                    <span class="message-timestamp"></span>
                </div>
                <div class="chat-msg-bubble chat-msg-bubble-user corporate-message-user user-content"></div>
                <div class="msg-actions" role="group" aria-label="Действия с сообщением"></div>
            </div>
        </div>
    </div>
</template>

<template id="ai-msg-template">
    <div class="chat-msg chat-msg-ai corporate-message-wrapper" data-role="ai-msg">
        <div class="chat-msg-shell">
            <div class="chat-avatar chat-avatar-ai">
                <span class="material-icons-round">support_agent</span>
            </div>
            <div class="chat-msg-body">
                <div class="chat-msg-meta">
                    <span class="chat-msg-author">AI Assistant</span>
                    <span class="message-timestamp"></span>
                </div>
                <div class="chat-msg-bubble chat-msg-bubble-ai corporate-message-ai prose prose-invert max-w-none ai-content"></div>
                <div class="msg-actions" role="group" aria-label="Действия с сообщением"></div>
            </div>
        </div>
    </div>
</template>

<template id="thinking-template">
    <div class="chat-msg chat-msg-ai thinking-wrapper corporate-message-wrapper">
        <div class="chat-msg-shell">
            <div class="chat-avatar chat-avatar-ai">
                <span class="material-icons-round animate-pulse">hourglass_empty</span>
            </div>
            <div class="chat-msg-body">
                <div class="chat-msg-meta">
                    <span class="chat-msg-author">AI Assistant</span>
                    <span class="chat-msg-status">Processing...</span>
                </div>
                <div class="chat-msg-bubble chat-msg-bubble-ai">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
            <button type="button" class="btn-stop-stream" aria-label="Остановить ответ" title="Остановить стриминг">
                <span class="material-icons-round">stop</span>
                <span>Stop</span>
            </button>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Elements
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const sendIcon = document.getElementById('send-icon');
    const welcomeMsg = document.getElementById('welcome-message');
    const providerSelect = document.getElementById('provider-select');
    const modelSelect = document.getElementById('model-select');
    const useRagCheckbox = document.getElementById('use-rag');
    const chatSearchInput = document.getElementById('chat-search');

    // Текущий чат (null = новый диалог)
    let currentChatId = null;

    function getChatIdFromUrl() {
        try { return new URL(window.location.href).searchParams.get('chat_id') || null; } catch (e) { return null; }
    }
    function setChatIdInUrl(id) {
        const u = new URL(window.location.href);
        if (id != null) u.searchParams.set('chat_id', String(id)); else u.searchParams.delete('chat_id');
        window.history.replaceState({}, '', u.pathname + u.search);
        updateSessionBadge(id);
    }

    function updateSessionBadge(id) {
        const el = document.getElementById('chat-session-id');
        if (!el) return;
        el.textContent = id ? '#' + id : '—';
    }

    function updateRagStatus() {
        const el = document.getElementById('rag-status');
        const card = document.getElementById('rag-status-card');
        if (!el || !useRagCheckbox) return;
        const enabled = !!useRagCheckbox.checked;
        el.textContent = enabled ? 'On' : 'Off';
        if (card) card.classList.toggle('chat-status-card--off', !enabled);
    }

    if (useRagCheckbox) {
        useRagCheckbox.addEventListener('change', updateRagStatus);
        updateRagStatus();
    }

    function formatChatDate(iso) {
        if (!iso) return '';
        const date = new Date(iso);
        if (Number.isNaN(date.getTime())) return '';
        const now = new Date();
        const sameDay = date.toDateString() === now.toDateString();
        if (sameDay) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        const diff = now - date;
        const day = 24 * 60 * 60 * 1000;
        if (diff < 6 * day) {
            return date.toLocaleDateString([], { weekday: 'short' });
        }
        return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    function loadChats() {
        fetch('/api/chats/', { credentials: 'same-origin' })
            .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('Failed to load chats')); })
            .then(function(data) {
                const list = document.getElementById('chat-history-list');
                const emptyState = document.getElementById('chat-history-empty');
                const countEl = document.getElementById('chat-history-count');
                if (!list) return;
                list.innerHTML = '';
                const chats = data.chats || [];
                if (countEl) {
                    const countLabel = chats.length === 1 ? '1 chat' : chats.length + ' chats';
                    countEl.textContent = countLabel;
                }
                if (emptyState) emptyState.classList.toggle('hidden', chats.length > 0);

                chats.forEach(function(c) {
                    const item = document.createElement('div');
                    const isActive = currentChatId === c.id;
                    item.className = 'chat-history-item ' + (isActive ? 'chat-history-item--active' : '');
                    item.setAttribute('role', 'listitem');
                    item.dataset.chatId = c.id;
                    item.dataset.title = (c.title || '').toLowerCase();
                    item.dataset.preview = (c.preview || '').toLowerCase();

                    const title = document.createElement('div');
                    title.className = 'chat-history-item-title';
                    title.textContent = c.title || ('Чат #' + c.id);

                    const preview = document.createElement('div');
                    preview.className = 'chat-history-item-preview';
                    preview.textContent = c.preview || 'Нет сообщений';

                    const meta = document.createElement('div');
                    meta.className = 'chat-history-item-meta';

                    const date = document.createElement('span');
                    date.className = 'chat-history-item-date';
                    date.textContent = formatChatDate(c.last_message_at || c.updated_at);

                    meta.appendChild(date);

                    item.appendChild(title);
                    item.appendChild(preview);
                    item.appendChild(meta);

                    item.addEventListener('click', function() { loadChat(c.id); });
                    list.appendChild(item);
                });
                applyChatFilter();
            })
            .catch(function() {});
    }

    function applyChatFilter() {
        if (!chatSearchInput) return;
        const q = chatSearchInput.value.trim().toLowerCase();
        const list = document.getElementById('chat-history-list');
        if (!list) return;
        const items = list.querySelectorAll('.chat-history-item');
        items.forEach(function(item) {
            if (!q) {
                item.classList.remove('hidden');
                return;
            }
            const title = item.dataset.title || '';
            const preview = item.dataset.preview || '';
            const match = title.includes(q) || preview.includes(q);
            item.classList.toggle('hidden', !match);
        });
    }

    if (chatSearchInput) {
        chatSearchInput.addEventListener('input', applyChatFilter);
    }

    function loadChat(id) {
        currentChatId = id;
        setChatIdInUrl(id);
        loadChats();
        fetch('/api/chats/' + id + '/', { credentials: 'same-origin' })
            .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('Not found')); })
            .then(function(data) {
                chatContainer.querySelectorAll('.corporate-message-wrapper, .thinking-wrapper').forEach(function(el) { el.remove(); });
                if (welcomeMsg) welcomeMsg.style.display = 'none';
                (data.messages || []).forEach(function(m) {
                    var content = appendMessage(m.role === 'user' ? m.content : '', m.role === 'user' ? 'user' : 'ai');
                    if (m.role === 'assistant' && m.content) {
                        content.innerHTML = (typeof marked !== 'undefined' ? marked.parse(m.content) : m.content);
                        if (typeof hljs !== 'undefined') content.querySelectorAll('pre code').forEach(function(block) { hljs.highlightElement(block); });
                        attachCopyButtons(content);
                    }
                    var wrapper = content && content.closest('.corporate-message-wrapper');
                    if (wrapper) attachMessageActions(wrapper, m.role === 'user' ? 'user' : 'ai', content);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            })
            .catch(function() {
                if (typeof showToast === 'function') showToast('Не удалось загрузить чат', 'error');
            });
    }

    function startNewChat() {
        currentChatId = null;
        setChatIdInUrl(null);
        clearChat();
        loadChats();
    }

    document.getElementById('btn-new-chat').addEventListener('click', startNewChat);
    function setChatSidebarOpen(open) {
        const sidebar = document.getElementById('chat-history-sidebar');
        const expandTab = document.getElementById('chat-sidebar-expand-tab');
        if (!sidebar || !expandTab) return;
        if (open) {
            sidebar.classList.remove('chat-history-sidebar--hidden');
            expandTab.classList.add('hidden');
        } else {
            sidebar.classList.add('chat-history-sidebar--hidden');
            expandTab.classList.remove('hidden');
        }
    }
    document.getElementById('btn-toggle-sidebar').addEventListener('click', function() {
        const sidebar = document.getElementById('chat-history-sidebar');
        const isHidden = sidebar.classList.toggle('chat-history-sidebar--hidden');
        document.getElementById('chat-sidebar-expand-tab').classList.toggle('hidden', !isHidden);
    });
    var expandTabEl = document.getElementById('chat-sidebar-expand-tab');
    if (expandTabEl) expandTabEl.addEventListener('click', function() { setChatSidebarOpen(true); });

    // Models per provider (for model-select)
    const MODEL_OPTIONS = {
        gemini: [
            { value: 'gemini-2.0-flash-exp', label: 'gemini-2.0-flash-exp' },
            { value: 'gemini-1.5-pro', label: 'gemini-1.5-pro' },
            { value: 'gemini-1.5-flash', label: 'gemini-1.5-flash' }
        ],
        grok: [
            { value: 'grok-3', label: 'grok-3' },
            { value: 'grok-4-1-fast-non-reasoning', label: 'grok-4-1-fast-non-reasoning' },
            { value: 'grok-beta', label: 'grok-beta' },
            { value: 'grok-2', label: 'grok-2' }
        ]
    };

    function updateModelOptions() {
        const provider = providerSelect.value;
        const sep = document.getElementById('model-sep');
        if (provider === 'auto' || provider === 'cursor') {
            if (sep) sep.style.display = 'none';
            if (modelSelect) modelSelect.style.display = 'none';
            return;
        }
        if (sep) sep.style.display = '';
        if (modelSelect) modelSelect.style.display = '';
        const options = MODEL_OPTIONS[provider] || MODEL_OPTIONS.gemini;
        const currentModel = modelSelect.value;
        modelSelect.innerHTML = '';
        options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt.value;
            o.textContent = opt.label;
            if (opt.value === currentModel) o.selected = true;
            modelSelect.appendChild(o);
        });
        if (!options.find(o => o.value === currentModel)) {
            modelSelect.selectedIndex = 0;
        }
    }
    providerSelect.addEventListener('change', function() { updateModelOptions(); syncHeaderModel(); });
    modelSelect.addEventListener('change', syncHeaderModel);
    updateModelOptions();

    function syncHeaderModel() {
        var el = document.getElementById('header-current-model');
        var local = document.getElementById('chat-current-model');
        if (!el && !local) return;
        let label = 'Auto';
        if (providerSelect.value === 'auto') {
            label = 'Smart Auto';
        } else if (providerSelect.value === 'cursor') {
            label = 'Cursor CLI';
        } else if (modelSelect && modelSelect.options.length) {
            var opt = modelSelect.options[modelSelect.selectedIndex];
            label = opt ? opt.text : modelSelect.value;
        }
        if (el) el.textContent = label;
        if (local) local.textContent = label;
    }
    syncHeaderModel();

    // Configure marked
    marked.setOptions({
        highlight: function (code, lang) {
            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
        },
        breaks: true,
        gfm: true
    });

    // Event Listeners
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendBtn.addEventListener('click', function() { sendMessage(); });

    // Quick action helper
    function insertPrompt(text) {
        chatInput.value = text;
        chatInput.focus();
        chatInput.style.height = '';
        chatInput.style.height = chatInput.scrollHeight + 'px';
    }

    // Clear chat — сбрасывает текущий чат и показывает приветствие
    function clearChat() {
        if (!confirm('Очистить всю историю чатов?')) return;
        var wrappers = chatContainer.querySelectorAll('.corporate-message-wrapper, .thinking-wrapper');
        wrappers.forEach(function(msg) { msg.remove(); });
        if (welcomeMsg) welcomeMsg.style.display = 'flex';
        currentChatId = null;
        setChatIdInUrl(null);
        loadChats();
        fetch('/api/clear-history/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
        }).catch(function(){});
    }

    // Shortcuts help: focus trap and a11y
    var shortcutsHelpTrapRef = null;
    function showShortcutsHelp() {
        var overlay = document.getElementById('shortcuts-help-overlay');
        var dialog = document.getElementById('shortcuts-help-dialog');
        var closeBtn = document.getElementById('shortcuts-help-close');
        if (overlay) {
            overlay.classList.remove('hidden');
            overlay.setAttribute('aria-hidden', 'false');
            if (closeBtn) closeBtn.focus();
            shortcutsHelpTrapRef = function(e) {
                if (e.key !== 'Tab' || !dialog) return;
                var focusables = dialog.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                var first = focusables[0], last = focusables[focusables.length - 1];
                if (e.shiftKey) {
                    if (document.activeElement === first) { e.preventDefault(); last && last.focus(); }
                } else {
                    if (document.activeElement === last) { e.preventDefault(); first && first.focus(); }
                }
            };
            overlay.addEventListener('keydown', shortcutsHelpTrapRef);
        }
    }

    function hideShortcutsHelp() {
        var overlay = document.getElementById('shortcuts-help-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
            overlay.setAttribute('aria-hidden', 'true');
            if (shortcutsHelpTrapRef) {
                overlay.removeEventListener('keydown', shortcutsHelpTrapRef);
                shortcutsHelpTrapRef = null;
            }
            var btn = document.getElementById('btn-shortcuts-help');
            if (btn) btn.focus();
        }
    }

    // Chat instructions toggle
    const chatInfoBtn = document.getElementById('btn-chat-info');
    const chatInstructions = document.getElementById('chat-instructions');
    if (chatInfoBtn && chatInstructions) {
        chatInfoBtn.addEventListener('click', function() {
            chatInstructions.classList.toggle('hidden');
        });
    }

    // Global keydown: Ctrl/Cmd+Enter, Ctrl/Cmd+/, Ctrl/Cmd+L
    document.addEventListener('keydown', function(e) {
        const mod = e.ctrlKey || e.metaKey;
        if (!mod) return;

        if (e.key === 'Enter') {
            if (document.activeElement !== chatInput) {
                e.preventDefault();
                sendMessage();
            }
            return;
        }
        if (e.key === '/') {
            e.preventDefault();
            showShortcutsHelp();
            return;
        }
        if (e.key === 'l' || e.key === 'L') {
            e.preventDefault();
            clearChat();
            return;
        }
    });

    // Close shortcuts overlay on Escape or click outside
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideShortcutsHelp();
        }
    });
    (function() {
        const overlay = document.getElementById('shortcuts-help-overlay');
        if (overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) hideShortcutsHelp();
            });
        }
    })();

    // AbortController for stop streaming
    var currentChatAbortController = null;

    // Main send function
    async function sendMessage(overriddenText) {
        // Клик по кнопке передаёт Event — не использовать как текст
        if (overriddenText && typeof overriddenText === 'object' && typeof overriddenText.preventDefault === 'function') {
            overriddenText = null;
        }
        const text = (overriddenText != null ? String(overriddenText).trim() : chatInput.value.trim());
        if (!text) return;

        // Reset UI
        if (overriddenText == null) {
            chatInput.value = '';
            chatInput.style.height = 'auto';
        }
        sendBtn.classList.add('btn-loading');
        sendBtn.disabled = true;

        if (welcomeMsg) {
            welcomeMsg.style.display = 'none';
        }

        // Add user message (only if not retry — retry doesn't add again)
        if (overriddenText == null) {
            var userContent = appendMessage(text, 'user');
            var userWrapper = userContent && userContent.closest('.corporate-message-wrapper');
            if (userWrapper) attachMessageActions(userWrapper, 'user', userContent);
        }

        // Add thinking indicator
        const thinkingEl = appendThinking();
        if (currentChatAbortController) currentChatAbortController.abort();
        currentChatAbortController = new AbortController();
        var stopBtn = thinkingEl.querySelector && thinkingEl.querySelector('.btn-stop-stream');
        if (stopBtn) {
            stopBtn.onclick = function() { currentChatAbortController && currentChatAbortController.abort(); };
        }

        try {
            const response = await fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: text,
                    model: providerSelect ? providerSelect.value : 'auto',
                    specific_model: (providerSelect && (providerSelect.value === 'auto' || providerSelect.value === 'cursor')) ? undefined : (modelSelect ? modelSelect.value : undefined),
                    use_rag: useRagCheckbox && useRagCheckbox.checked,
                    chat_id: currentChatId,
                    mode: document.getElementById('orchestrator-mode-select') ? document.getElementById('orchestrator-mode-select').value : 'chat'
                }),
                signal: currentChatAbortController.signal
            });

            if (!response.ok) {
                if (response.status === 429 && typeof showToast === 'function') {
                    showToast('Превышен лимит запросов. Подождите и попробуйте снова.', 'error', 6000);
                }
                throw new Error('HTTP ' + response.status);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let rawBuffer = '';
            let displayText = '';
            let aiContentDiv = null;

            function processLine(line) {
                var trimmed = (line || '').trim();
                if (!trimmed) return;
                if (/^CHAT_ID:(\d+)$/.test(trimmed)) {
                    var m = /^CHAT_ID:(\d+)$/.exec(trimmed);
                    if (m) {
                        currentChatId = parseInt(m[1], 10);
                        setChatIdInUrl(currentChatId);
                        loadChats();
                    }
                    return;
                }
                try {
                    var o = JSON.parse(line);
                    if (o && o.type === 'assistant' && o.message && Array.isArray(o.message.content)) {
                        var extracted = '';
                        for (var j = 0; j < o.message.content.length; j++) {
                            var c = o.message.content[j];
                            if (c && c.type === 'text' && typeof c.text === 'string') extracted += c.text;
                        }
                        // Кумулятивная логика: новый текст является расширением старого — заменяем
                        if (extracted && extracted.length >= displayText.length && extracted.indexOf(displayText) === 0) {
                            displayText = extracted;
                        }
                        // Старый текст является началом нового — заменяем (тот же случай)
                        else if (extracted && displayText.indexOf(extracted) === 0) {
                            // extracted — подмножество displayText, игнорируем (уже есть)
                        }
                        // Полный дубликат — игнорируем
                        else if (extracted && displayText === extracted) {
                            // дубликат, пропускаем
                        }
                        // Новый уникальный контент — добавляем
                        else if (extracted && displayText.indexOf(extracted) === -1) {
                            displayText += extracted;
                        }
                    }
                } catch (e) {
                    // Плоский текст (не JSON) — добавляем если не дубликат
                    if (displayText.indexOf(line) === -1) {
                        displayText += line + '\n';
                    }
                }
            }

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                rawBuffer += decoder.decode(value, { stream: true });
                var lines = rawBuffer.split('\n');
                rawBuffer = lines.pop() || '';

                for (var i = 0; i < lines.length; i++) processLine(lines[i]);

                if (!aiContentDiv && displayText.length > 0) {
                    thinkingEl.remove();
                    aiContentDiv = appendMessage('', 'ai');
                }
                if (aiContentDiv) {
                    aiContentDiv.innerHTML = marked.parse(displayText);
                    if (typeof hljs !== 'undefined') {
                        aiContentDiv.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                    attachCopyButtons(aiContentDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            if (rawBuffer.trim()) processLine(rawBuffer);

            if (!aiContentDiv) {
                thinkingEl.remove();
                aiContentDiv = appendMessage(displayText || 'No response received.', 'ai');
                if (displayText) aiContentDiv.innerHTML = marked.parse(displayText);
                if (typeof hljs !== 'undefined') aiContentDiv.querySelectorAll('pre code').forEach(function(b){ hljs.highlightElement(b); });
                attachCopyButtons(aiContentDiv);
            }
            var aiWrapper = aiContentDiv && aiContentDiv.closest('.corporate-message-wrapper');
            if (aiWrapper) attachMessageActions(aiWrapper, 'ai', aiContentDiv);

        } catch (error) {
            if (error.name === 'AbortError') {
                thinkingEl.remove();
                if (typeof showToast === 'function') showToast('Ответ остановлен', 'info', 2000);
                return;
            }
            console.error('Chat error:', error);
            thinkingEl.remove();
            const errorContent = appendMessage('', 'ai');
            errorContent.innerHTML = `
                <div class="flex items-center gap-2 text-red-400">
                    <span class="material-icons-round text-lg">error_outline</span>
                    <span>Error: ${error.message}</span>
                </div>
            `;
            var errWrapper = errorContent.closest('.corporate-message-wrapper');
            if (errWrapper) attachMessageActions(errWrapper, 'ai', errorContent);
            if (typeof showToast === 'function' && error.message.indexOf('429') < 0) showToast('Ошибка: ' + error.message, 'error', 4000);
        } finally {
            currentChatAbortController = null;
            sendBtn.classList.remove('btn-loading');
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    // Format timestamp
    function formatTimestamp(date = new Date()) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // Append message to chat
    function appendMessage(text, type) {
        const template = document.getElementById(type === 'user' ? 'user-msg-template' : 'ai-msg-template');
        const clone = template.content.cloneNode(true);

        // Add timestamp
        const timestampEl = clone.querySelector('.message-timestamp');
        if (timestampEl) {
            timestampEl.textContent = formatTimestamp();
        }

        let contentDiv;
        if (type === 'user') {
            contentDiv = clone.querySelector('.user-content');
            contentDiv.textContent = text;
        } else {
            contentDiv = clone.querySelector('.ai-content');
            if (text) {
                contentDiv.innerHTML = marked.parse(text);
            }
        }

        chatContainer.appendChild(clone);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const messages = chatContainer.querySelectorAll(type === 'user' ? '.user-content' : '.ai-content');
        return messages[messages.length - 1];
    }

    // Add thinking indicator
    function appendThinking() {
        const template = document.getElementById('thinking-template');
        const clone = template.content.cloneNode(true);
        chatContainer.appendChild(clone);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const wrappers = chatContainer.querySelectorAll('.thinking-wrapper');
        return wrappers[wrappers.length - 1];
    }

    // Message actions: copy whole, copy code, retry (ai)
    function attachMessageActions(wrapper, type, contentEl) {
        var actionsDiv = wrapper && wrapper.querySelector('.msg-actions');
        if (!actionsDiv || !contentEl) return;
        actionsDiv.innerHTML = '';

        function addBtn(icon, label, onClick) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'msg-action-btn';
            btn.setAttribute('aria-label', label);
            btn.innerHTML = '<span class="material-icons-round" aria-hidden="true">' + icon + '</span> ' + label;
            btn.addEventListener('click', onClick);
            actionsDiv.appendChild(btn);
        }

        function copyToClip(s) {
            navigator.clipboard.writeText(s || '').then(function() {
                if (typeof showToast === 'function') showToast('Скопировано', 'success', 2000);
            }).catch(function() {
                if (typeof showToast === 'function') showToast('Ошибка копирования', 'error', 2000);
            });
        }

        addBtn('content_copy', 'Copy', function() { copyToClip(contentEl.textContent); });

        if (type === 'ai') {
            var codes = contentEl.querySelectorAll('pre code');
            if (codes.length) {
                var allCode = Array.prototype.map.call(codes, function(c) { return c.textContent || ''; }).join('\n\n');
                if (allCode) addBtn('code', 'Copy code', function() { copyToClip(allCode); });
            }
            var aiWrappers = chatContainer.querySelectorAll('[data-role="ai-msg"]');
            var isLast = wrapper.getAttribute('data-role') === 'ai-msg' && aiWrappers.length && aiWrappers[aiWrappers.length - 1] === wrapper;
            if (isLast) {
                addBtn('replay', 'Retry', function() {
                    var prev = wrapper.previousElementSibling;
                    while (prev && prev.getAttribute('data-role') !== 'user-msg') prev = prev.previousElementSibling;
                    var prevText = prev && prev.querySelector('.user-content') && prev.querySelector('.user-content').textContent;
                    if (prevText) {
                        wrapper.remove();
                        sendMessage(prevText);
                    }
                });
            }
        }
    }

    // Add copy buttons to code blocks (pre>code or .code-block)
    function attachCopyButtons(container) {
        if (!container) return;
        container.querySelectorAll('pre').forEach(function (pre) {
            const code = pre.querySelector('code');
            if (!code) return;
            if (pre.querySelector('.copy-btn')) return;
            pre.classList.add('code-block');
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'copy-btn';
            btn.title = 'Копировать';
            btn.setAttribute('aria-label', 'Copy code block');
            btn.innerHTML = '<span class="material-icons-round copy-icon" aria-hidden="true">content_copy</span>';
            btn.addEventListener('click', async function () {
                const text = code.textContent || '';
                try {
                    await navigator.clipboard.writeText(text);
                    if (typeof showToast === 'function') showToast('Скопировано', 'success', 2000);
                    var icon = btn.querySelector('.copy-icon');
                    if (icon) {
                        icon.textContent = 'check';
                        setTimeout(function () { icon.textContent = 'content_copy'; }, 2000);
                    }
                } catch (e) {
                    if (typeof showToast === 'function') showToast('Ошибка копирования', 'error', 2000);
                }
            });
            pre.appendChild(btn);
        });
    }

    // CSRF from common.js — window.getCookie('csrftoken')
    var getCookie = window.getCookie || function() { return null; };

    // File upload handling
    const fileInput = document.getElementById('file-input');
    const attachedFilesDiv = document.getElementById('attached-files');
    const inputContainer = document.getElementById('input-container');
    let attachedFiles = [];

    fileInput.addEventListener('change', (e) => {
        handleFiles(Array.from(e.target.files));
    });

    function handleFiles(files) {
        files.forEach(file => {
            if (!attachedFiles.find(f => f.name === file.name && f.size === file.size)) {
                attachedFiles.push(file);
                uploadFile(file);
            }
        });
        fileInput.value = ''; // Reset input
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.remove('drag-over');

        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.remove('drag-over');
    }

    async function uploadFile(file) {
        // Show file in attached files list
        const fileId = `file-${Date.now()}-${Math.random()}`;
        const fileItem = document.createElement('div');
        fileItem.id = fileId;
        fileItem.className = 'chat-attachment-item';
        fileItem.innerHTML = `
            <div class="chat-attachment-icon">
                <span class="material-icons-round">description</span>
            </div>
            <div class="chat-attachment-body">
                <div class="chat-attachment-title">${file.name}</div>
                <div class="chat-attachment-meta">${formatFileSize(file.size)}</div>
            </div>
            <span class="material-icons-round chat-attachment-spin">hourglass_empty</span>
        `;
        attachedFilesDiv.appendChild(fileItem);
        attachedFilesDiv.classList.remove('hidden');

        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/chat/upload/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                fileItem.innerHTML = `
                    <div class="chat-attachment-icon success">
                        <span class="material-icons-round">check_circle</span>
                    </div>
                    <div class="chat-attachment-body">
                        <div class="chat-attachment-title">${file.name}</div>
                        <div class="chat-attachment-meta">${formatFileSize(file.size)} • Uploaded</div>
                    </div>
                    <button type="button" onclick="removeFile('${fileId}', '${file.name}')" class="chat-icon-btn" aria-label="Remove file ${String(file.name).replace(/"/g, '&quot;')}">
                        <span class="material-icons-round" aria-hidden="true">close</span>
                    </button>
                `;

                // Show success notification
                if (typeof showToast === 'function') showToast(`Файл "${file.name}" загружен и добавлен в базу знаний`, 'success');
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        } catch (error) {
            console.error('Upload error:', error);
            fileItem.innerHTML = `
                <div class="chat-attachment-icon error">
                    <span class="material-icons-round">error</span>
                </div>
                <div class="chat-attachment-body">
                    <div class="chat-attachment-title">${file.name}</div>
                    <div class="chat-attachment-meta error">Upload failed</div>
                </div>
                <button type="button" onclick="removeFile('${fileId}', '${file.name}')" class="chat-icon-btn" aria-label="Remove file ${String(file.name).replace(/"/g, '&quot;')}">
                    <span class="material-icons-round" aria-hidden="true">close</span>
                </button>
            `;
            if (typeof showToast === 'function') showToast(`Ошибка загрузки "${file.name}": ${error.message}`, 'error');
        }
    }

    function removeFile(fileId, fileName) {
        const fileItem = document.getElementById(fileId);
        if (fileItem) {
            fileItem.remove();
        }
        attachedFiles = attachedFiles.filter(f => f.name !== fileName);

        if (attachedFiles.length === 0) {
            attachedFilesDiv.classList.add('hidden');
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Focus input on load
    chatInput.focus();

    // Task context from URL (task_id): загрузить задачу и показать над полем ввода
    function getTaskIdFromUrl() {
        try {
            return new URL(window.location.href).searchParams.get('task_id') || null;
        } catch (e) {
            return null;
        }
    }

    function showTaskContext(task) {
        var panel = document.getElementById('task-context-panel');
        var titleEl = document.getElementById('task-context-title');
        var descEl = document.getElementById('task-context-desc');
        var statusEl = document.getElementById('task-context-status');
        var linkEl = document.getElementById('task-context-link');
        if (!panel || !titleEl || !descEl) return;
        titleEl.textContent = task.title || '';
        descEl.textContent = (task.description || '').trim() || '—';
        var statusText = task.status === 'TODO' ? 'К выполнению' : (task.status === 'IN_PROGRESS' ? 'В работе' : (task.status === 'DONE' ? 'Выполнена' : (task.status || '')));
        statusEl.textContent = statusText;
        statusEl.setAttribute('title', 'Статус задачи: ' + statusText);
        if (linkEl) linkEl.href = '/tasks/';
        panel.classList.remove('hidden');
    }

    function loadTaskContextIfPresent() {
        var taskId = getTaskIdFromUrl();
        if (!taskId) return;
        fetch('/tasks/' + taskId + '/', { credentials: 'same-origin', headers: { 'Accept': 'application/json' } })
            .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('Task not found')); })
            .then(showTaskContext)
            .catch(function() {});
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTaskContextIfPresent);
    } else {
        loadTaskContextIfPresent();
    }

    // Check API keys on load (non-blocking, user can close toast)
    function runSettingsCheck() {
        fetch('/api/settings/check/')
            .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
            .then(function(data) {
                if (data && data.configured === false && typeof showToast === 'function') {
                    showToast('Не настроены API ключи. Перейдите в Настройки', 'warning', 10000, '/settings/');
                }
            })
            .catch(function() {});
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', runSettingsCheck);
    } else {
        runSettingsCheck();
    }

    // Инициализация истории чатов: загрузить список и при ?chat_id= — открыть этот чат
    function initChatHistory() {
        loadChats();
        var chatId = getChatIdFromUrl();
        if (chatId) loadChat(parseInt(chatId, 10));
        updateSessionBadge(chatId);
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChatHistory);
    } else {
        initChatHistory();
    }

    // ==========================================
    // Task Modal Functions
    // ==========================================
    let currentTaskId = null;

    function openTaskModal(taskId) {
        currentTaskId = taskId;
        const modal = document.getElementById('task-modal');

        // Fetch task details
        fetch(`/tasks/${taskId}/`)
            .then(res => res.json())
            .then(data => {
                // Populate modal
                document.getElementById('task-modal-title').textContent = data.title;
                document.getElementById('task-modal-status').textContent = data.status.replace('_', ' ');

                const priorityBadge = document.getElementById('task-modal-priority');
                priorityBadge.textContent = data.priority || 'MEDIUM';
                priorityBadge.className = 'task-badge task-badge-priority';
                if (data.priority === 'HIGH') priorityBadge.classList.add('priority-high');
                if (data.priority === 'LOW') priorityBadge.classList.add('priority-low');

                document.getElementById('task-modal-assignee').textContent =
                    data.assignee ? `Assigned to: ${data.assignee}` : 'Unassigned';

                document.getElementById('task-modal-description').textContent =
                    data.description || 'No description provided.';

                document.getElementById('task-modal-due-date').textContent =
                    data.due_date ? new Date(data.due_date).toLocaleDateString() : '—';

                document.getElementById('task-modal-server').textContent =
                    data.target_server || '—';

                document.getElementById('task-modal-created').textContent =
                    new Date(data.created_at).toLocaleString();

                document.getElementById('task-modal-updated').textContent =
                    new Date(data.updated_at).toLocaleString();

                document.getElementById('task-modal-completed').textContent =
                    data.completed_at ? new Date(data.completed_at).toLocaleString() : '—';

                // Show modal
                modal.classList.remove('hidden');
            })
            .catch(err => {
                console.error('Failed to load task:', err);
                alert('Failed to load task details');
            });
    }

    function closeTaskModal() {
        document.getElementById('task-modal').classList.add('hidden');
        currentTaskId = null;
    }

    function discussTask() {
        if (!currentTaskId) return;
        closeTaskModal();

        // Insert prompt to discuss task
        const taskTitle = document.getElementById('task-modal-title').textContent;
        chatInput.value = `Let's discuss task #${currentTaskId}: ${taskTitle}`;
        chatInput.style.height = '';
        chatInput.style.height = chatInput.scrollHeight + 'px';
        chatInput.focus();
    }

    function takeTaskInProgress() {
        if (!currentTaskId) return;

        if (confirm('Start working on this task?')) {
            fetch(`/tasks/${currentTaskId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: 'IN_PROGRESS' })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeTaskModal();
                    // Insert confirmation message
                    chatInput.value = `Task #${currentTaskId} moved to IN PROGRESS. What should I work on first?`;
                    chatInput.focus();
                } else {
                    alert('Failed to update task status');
                }
            })
            .catch(err => {
                console.error('Failed to update task:', err);
                alert('Failed to update task');
            });
        }
    }

    function openTaskPage() {
        if (!currentTaskId) return;
        window.open(`/tasks/${currentTaskId}/`, '_blank');
    }

    // Handle clicks on task: links in chat
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a[href^="task:"]');
        if (link) {
            e.preventDefault();
            const taskId = link.getAttribute('href').replace('task:', '');
            openTaskModal(taskId);
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('task-modal');
            if (!modal.classList.contains('hidden')) {
                closeTaskModal();
            }
        }
    });

    // Check for initial prompt
    {% if initial_prompt %}
    setTimeout(() => {
        chatInput.value = `{{ initial_prompt|escapejs }}`;
        chatInput.style.height = '';
        chatInput.style.height = chatInput.scrollHeight + 'px';
        sendMessage();
    }, 500);
    {% endif %}
</script>
{% endblock %}
